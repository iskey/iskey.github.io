<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Iptables | Iskey's Blog]]></title>
  <link href="http://iskey.github.io/blog/categories/iptables/atom.xml" rel="self"/>
  <link href="http://iskey.github.io/"/>
  <updated>2019-07-13T11:48:46+00:00</updated>
  <id>http://iskey.github.io/</id>
  <author>
    <name><![CDATA[Iskey]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Iptables时间规则匹配]]></title>
    <link href="http://iskey.github.io/blog/2018/04/27/iptables-with-time/"/>
    <updated>2018-04-27T11:25:48+00:00</updated>
    <id>http://iskey.github.io/blog/2018/04/27/iptables-with-time</id>
    <content type="html"><![CDATA[<p>1、每天固定时间段匹配</p>

<pre><code class="java">
iptables -I FORWARD -s 172.17.1.132 -d 192.168.1.119 -m time --timestart 09:40 --timestop 09:59 -j DROP
</code></pre>

<p>2、按周固定时间段匹配</p>

<pre><code>iptables -I FORWARD -s 172.17.1.132 -d 192.168.1.119 -m time --timestart 09:40 --timestop 09:59 --weekdays Wed,Thu -j DROP
</code></pre>

<p>3、按固定日期匹配，注这里比较特殊，可以看见下面的时间是17点不是9点，是因为时区的原因，要差8小时。</p>

<pre><code>iptables -I FORWARD -s 172.17.1.132 -d 192.168.1.119 -m time --datestart 2014-3-19T17:40:08 --datestop 2014-3-19T17:59:50 -j DROP
</code></pre>

<p>附上帮助说明：</p>

<pre><code>time match options:
    --datestart time     Start and stop time, to be given in ISO 8601
    --datestop time      (YYYY[-MM[-DD[Thh[:mm[:ss]]]]])
    --timestart time     Start and stop daytime (hh:mm[:ss])
    --timestop time      (between 00:00:00 and 23:59:59)
[!] --monthdays value    List of days on which to match, separated by comma
                         (Possible days: 1 to 31; defaults to all)
[!] --weekdays value     List of weekdays on which to match, sep. by comma
                         (Possible days: Mon,Tue,Wed,Thu,Fri,Sat,Sun or 1 to 7
                         Defaults to all weekdays.)
    --localtz/--utc      Time is interpreted as UTC/local time
</code></pre>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[重定向外部连接到本地环回地址]]></title>
    <link href="http://iskey.github.io/blog/2018/04/27/redirect-extern-request-to-localhost/"/>
    <updated>2018-04-27T09:12:37+00:00</updated>
    <id>http://iskey.github.io/blog/2018/04/27/redirect-extern-request-to-localhost</id>
    <content type="html"><![CDATA[<p>背景：在本地<code>localhost</code>搭建了一个Httpserver，监听在<code>4000</code>端口，现在想通过<code>eth0</code>在不改动代码的情况下对外发布服务。</p>

<p>最先想到的就是端口映射，<code>rinetd</code>服务，使用也很简单，直接配置外部ip到环回地址的映射就可以了:</p>

<pre><code class="java">root@lfgphicpra39095:/usr1/# cat /etc/rinetd.conf
......
#
# forwarding rules come here
#
# you may specify allow and deny rules after a specific forwarding rule
# to apply to only that forwarding rule
#
# bindadress    bindport  connectaddress  connectport

**10.252.64.154  4000 127.0.0.1 4000**
</code></pre>

<p>但是这样一来，一旦eth0的地址发生了改变，就需要再修改配置文件。</p>

<p>另一种方法就是通过iptables就行重定向：</p>

<pre><code>iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 4000 -j DNAT --to-destination 127.0.0.1
</code></pre>

<p>配置后，外部访问不通，通过抓包分析，协议栈没有回复<code>syc+ack</code>报文，看来是路由的问题。</p>

<p>内核协议栈会丢弃路由 对于源地址或目的地址为<code>loopback</code>地址的，内核协议栈的认为这是一个<code>martian packet</code>，直接丢弃。</p>

<pre><code>route_localnet – BOOLEAN: Do not consider loopback addresses as martian source or destination while routing. This enables the use of 127/8 for local routing purposes (default FALSE).
</code></pre>

<p>这个特性是对每个网卡设备生效的，所以只需要在<code>eth0</code>上开启环回地址路由就可以了</p>

<pre><code>echo 1 &gt; /proc/sys/net/ipv4/conf/eth0/route_localnet
</code></pre>
]]></content>
  </entry>
  
</feed>
