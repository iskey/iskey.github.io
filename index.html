
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Iskey's Blog</title>
  <meta name="author" content="Iskey">

  
  <meta name="description" content="ovs command 1
https://docs.pica8.com/pages/viewpage.action?pageId=3083175 useful command 1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
$ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://iskey.github.io/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Iskey's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Iskey's Blog</a></h1>
  
    <h2>A free place to write something down.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="iskey.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/02/08/ovs-qos/">QoS</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-02-08T03:28:15+00:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>8</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>3:28 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>ovs command</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>https://docs.pica8.com/pages/viewpage.action?pageId=3083175</span></code></pre></td></tr></table></div></figure>


<h2>useful command</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ovs-vsctl list port tap53eeb988-c7
</span><span class='line'>_uuid               : 4712ae65-bced-4ee3-bf7d-3b7fa1e52bb7
</span><span class='line'>bond_active_slave   : []
</span><span class='line'>bond_downdelay      : 0
</span><span class='line'>bond_fake_iface     : false
</span><span class='line'>bond_mode           : []
</span><span class='line'>bond_updelay        : 0
</span><span class='line'>external_ids        : {}
</span><span class='line'>fake_bridge         : false
</span><span class='line'>interfaces          : [1fe8bb0a-6383-45ba-bc86-46e1de03f4e0]
</span><span class='line'>lacp                : []
</span><span class='line'>mac                 : []
</span><span class='line'>name                : "tap53eeb988-c7"
</span><span class='line'>other_config        : {net_uuid="ea7d53f9-45c6-4027-98b5-23053d10373b", network_type=vlan, physical_network="physnet1", segmentation_id="332", tag="4"}
</span><span class='line'>qos                 : 82bd0134-4e76-405a-ac1d-22b4ea43e55a
</span><span class='line'>rstp_statistics     : {}
</span><span class='line'>rstp_status         : {}
</span><span class='line'>statistics          : {}
</span><span class='line'>status              : {}
</span><span class='line'>tag                 : 4
</span><span class='line'>trunks              : []
</span><span class='line'>vlan_mode           : []</span></code></pre></td></tr></table></div></figure>


<p>查看QOS属性</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ ovs-vsctl list qos 82bd0134-4e76-405a-ac1d-22b4ea43e55a
</span><span class='line'>_uuid               : 82bd0134-4e76-405a-ac1d-22b4ea43e55a
</span><span class='line'>external_ids        : {}
</span><span class='line'>other_config        : {max-rate="800000000"}
</span><span class='line'>queues              : {0=cc4e5d2e-2dbb-4e5b-a682-d6a28bd7b743}
</span><span class='line'>type                : linux-htb</span></code></pre></td></tr></table></div></figure>


<p>删除QOS并清除网卡QOS</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ovs-vsctl -- destroy QoS 82bd0134-4e76-405a-ac1d-22b4ea43e55a -- clear Port tap53eeb988 qos
</span></code></pre></td></tr></table></div></figure>


<h3>libvirtd 限速接口</h3>

<p>Libvirtd默认提供domiftune限制网卡流量</p>

<p>查看虚机接口的限速设置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>virsh  domiftune 4ffbd71f-3324-4500-8636-f9a275b6e479 tap53eeb988</span></code></pre></td></tr></table></div></figure>


<p>设置虚机接口限速</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ virsh domiftune 4ffbd71f-3324-4500-8636-f9a275b6e479 tap53eeb988 --inbound 700000,800000,800000 --outbount 700000,800000,800000 --live</span></code></pre></td></tr></table></div></figure>


<p>单位如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>average bandwidth   kilobytes/second 
</span><span class='line'>peak bandwidth      kilobytes/second 
</span><span class='line'>burst size          kilobytes</span></code></pre></td></tr></table></div></figure>


<p>这里要注意的是domiftune只针对网络模式为nat，route等方式，对模型为bridge, passthrough, private,和hostdev是不支持限制的。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/02/02/ansible-stress-scripts/">Ansible-stress</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-02-02T08:00:00+00:00'><span class='date'><span class='date-month'>Feb</span> <span class='date-day'>2</span><span class='date-suffix'>nd</span>, <span class='date-year'>2020</span></span> <span class='time'>8:00 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><!-- TOC -->


<ul>
<li><a href="#1-%E5%88%A9%E7%94%A8ansiblestress-ng%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95">1. 利用ansible、stress-ng进行压力测试</a>

<ul>
<li><a href="#11-%E5%8E%8B%E6%B5%8B%E5%88%A9%E5%99%A8-stress-ng">1.1. 压测利器-stress-ng</a></li>
<li><a href="#12-%E6%9C%80%E7%AE%80%E5%8D%95%E7%9A%84%E8%BF%90%E7%BB%B4%E5%B7%A5%E5%85%B7-ansible">1.2. 最简单的运维工具-ansible</a></li>
<li><a href="#13-%E5%A6%82%E4%BD%95%E7%AE%A1%E7%90%86%E5%8E%8B%E6%B5%8B%E8%BF%9B%E7%A8%8B-%E7%BB%99%E5%8E%8B%E6%B5%8B%E8%BF%9B%E7%A8%8B%E6%89%BE%E4%B8%AA%E7%88%B9">1.3. 如何管理压测进程-给压测进程找个爹</a></li>
<li><a href="#14-%E8%B4%9F%E8%BD%BD%E5%9C%BA%E6%99%AF%E5%89%A7%E6%9C%AC%E8%AE%BE%E8%AE%A1-playbook">1.4. 负载场景剧本设计-playbook</a></li>
<li><a href="#15-%E8%87%AA%E5%8A%A8%E9%87%8D%E8%AF%95-ansile%E7%BB%8F%E5%B8%B8%E4%B8%8D%E9%9D%A0%E8%B0%B1">1.5. 自动重试-ansile经常不靠谱</a></li>
</ul>
</li>
</ul>


<!-- /TOC -->


<h1>1. 利用ansible、stress-ng进行压力测试</h1>

<h2>1.1. 压测利器-stress-ng</h2>

<p>stress-ng是stress的加强版，完全兼容stress，并在此基础上增加了几百个参数，堪称压测工具中的瑞士军刀。</p>

<p>这里列举几个样例场景：</p>

<p>CPU密集型场景：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stress-ng --cpu 6 --timeout 300</span></code></pre></td></tr></table></div></figure>


<p>该命令会尽量占满6个CPU核</p>

<p>IO密集型场景：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stress-ng  -i 6 --hdd 1 --timeout 300</span></code></pre></td></tr></table></div></figure>


<p>该命令会开启1个worker不停的读写临时文件，同时启动6个workers不停的调用sync系统调用提交缓存，</p>

<p>进程密集型场景：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>(( proc_cnt = `nproc`*10 )); stress-ng --cpu $proc_cnt --pthread 1 timeout 300</span></code></pre></td></tr></table></div></figure>


<p>该命令会启动N*10个进程，在只有N个核的系统上，会产生大量的进程切换，模拟进程间竞争CPU的场景</p>

<p>线程密集型场景：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>stress-ng --cpu `nproc` --pthread 1024 timeout 300</span></code></pre></td></tr></table></div></figure>


<p>该命令会在N个CPU核的系统上，产生N个进程，每个进程1024个线程，模拟线程间竞争CPU的场景</p>

<p>其它常用样例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>    stress-ng --vm 8 --vm-bytes 80% -t 1h
</span><span class='line'>
</span><span class='line'>          run 8 virtual memory stressors that combined use 80% of the available memory for  1
</span><span class='line'>          hour. Thus each stressor uses 10% of the available memory.
</span><span class='line'>
</span><span class='line'>   stress-ng --cpu 4 --io 2 --vm 1 --vm-bytes 1G --timeout 60s
</span><span class='line'>
</span><span class='line'>          runs  for  60  seconds with 4 cpu stressors, 2 io stressors and 1 vm stressor using
</span><span class='line'>          1GB of virtual memory.
</span><span class='line'>
</span><span class='line'>   stress-ng --iomix 2 --iomix-bytes 10% -t 10m
</span><span class='line'>
</span><span class='line'>          runs 2 instances of the mixed I/O stressors using a total of 10% of  the  available
</span><span class='line'>          file  system  space for 10 minutes. Each stressor will use 5% of the available file
</span><span class='line'>          system space.
</span><span class='line'>
</span><span class='line'>   stress-ng  --cyclic  1  --cyclic-dist  2500  --cyclic-method  clock_ns  --cyclic-prio  100
</span><span class='line'>   --cyclic-sleep 10000 --hdd 0 -t 1m
</span><span class='line'>
</span><span class='line'>          measures  real time scheduling latencies created by the hdd stressor. This uses the
</span><span class='line'>          high resolution nanosecond clock to  measure  latencies  during  sleeps  of  10,000
</span><span class='line'>          nanoseconds.  At  the  end  of 1 minute of stressing, the latency distribution with
</span><span class='line'>          2500 ns intervals will be displayed.  NOTE:  this  must  be  run  with  super  user
</span><span class='line'>          privileges to enable the real time scheduling to get accurate measurements.
</span><span class='line'>
</span><span class='line'>   stress-ng --cpu 8 --cpu-ops 800000
</span><span class='line'>
</span><span class='line'>          runs 8 cpu stressors and stops after 800000 bogo operations.
</span><span class='line'>
</span><span class='line'>   stress-ng --sequential 2 --timeout 2m --metrics
</span><span class='line'>
</span><span class='line'>          run 2 simultaneous instances of all the stressors sequentially one by one, each for
</span><span class='line'>          2 minutes and summarise with performance metrics at the end.
</span><span class='line'>
</span><span class='line'>   stress-ng --cpu 4 --cpu-method fft --cpu-ops 10000 --metrics-brief
</span><span class='line'>
</span><span class='line'>          run 4 FFT cpu stressors, stop after 10000 bogo operations  and  produce  a  summary
</span><span class='line'>          just for the FFT results.
</span><span class='line'>
</span><span class='line'>   stress-ng --cpu 0 --cpu-method all -t 1h
</span><span class='line'>
</span><span class='line'>          run  cpu  stressors  on  all  online  CPUs  working  through  all the available CPU
</span><span class='line'>          stressors for 1 hour.
</span><span class='line'>
</span><span class='line'>   stress-ng --all 4 --timeout 5m
</span><span class='line'>
</span><span class='line'>          run 4 instances of all the stressors for 5 minutes.
</span><span class='line'>
</span><span class='line'>   stress-ng --random 64
</span><span class='line'>
</span><span class='line'>          run 64 stressors that are randomly chosen from all the available stressors.
</span><span class='line'>
</span><span class='line'>   stress-ng --cpu 64 --cpu-method all --verify -t 10m --metrics-brief
</span><span class='line'>
</span><span class='line'>          run  64  instances  of  all  the  different  cpu  stressors  and  verify  that  the
</span><span class='line'>          computations are correct for 10 minutes with a bogo operations summary at the end.
</span><span class='line'>
</span><span class='line'>   stress-ng --sequential 0 -t 10m
</span><span class='line'>
</span><span class='line'>          run  all  the  stressors one by one for 10 minutes, with the number of instances of
</span><span class='line'>          each stressor matching the number of online CPUs.
</span><span class='line'>
</span><span class='line'>   stress-ng --sequential 8 --class io -t 5m --times
</span><span class='line'>
</span><span class='line'>          run all the stressors in the io class one  by  one  for  5  minutes  each,  with  8
</span><span class='line'>          instances  of  each stressor running concurrently and show overall time utilisation
</span><span class='line'>          statistics at the end of the run.
</span><span class='line'>
</span><span class='line'>   stress-ng --all 0 --maximize --aggressive
</span><span class='line'>
</span><span class='line'>          run all the stressors (1 instance of each per  CPU)  simultaneously,  maximize  the
</span><span class='line'>          settings   (memory   sizes,   file   allocations,   etc.)   and   select  the  most
</span><span class='line'>          demanding/aggressive options.
</span><span class='line'>
</span><span class='line'>   stress-ng --random 32 -x numa,hdd,key
</span><span class='line'>
</span><span class='line'>          run 32 randomly selected stressors and exclude the numa, hdd and key stressors
</span><span class='line'>
</span><span class='line'>   stress-ng --sequential 4 --class vm --exclude bigheap,brk,stack
</span><span class='line'>
</span><span class='line'>          run 4 instances of the VM stressors one after each other,  excluding  the  bigheap,
</span><span class='line'>          brk and stack stressors
</span><span class='line'>
</span><span class='line'>   stress-ng --taskset 0,2-3 --cpu 3
</span><span class='line'>
</span><span class='line'>          run 3 instances of the CPU stressor and pin them to CPUs 0, 2 and 3.
</span></code></pre></td></tr></table></div></figure>


<h2>1.2. 最简单的运维工具-ansible</h2>

<p>在小规模的机器上执行命令，最简单非ansible莫属，因为ansible默认是不需要在待运维的机器上安装额外的服务，
只要开启了ssh服务就可以了。</p>

<p>一个简单的ansible使用样例，<a href="https://iskey.github.io/blog/2019/07/07/simple-example-of-ansible/">simple-example-of-ansible</a></p>

<h2>1.3. 如何管理压测进程-给压测进程找个爹</h2>

<p>使用ansible进行加压时，如果执行stress-ng命令，然后马上退出，压测工具进程也就被杀死了，这是因为压测工具默认的父进程是ansible的ssh会话
这时候可以使用nohup、setsid命令让stress-ng命令后台执行。
在稍微复杂的场景模拟时，stress-ng可能会启动很多的进程，并且有些时候不仅有stress-ng，而且可能还需要sys-bench等工具，
当需要调整压力时，可能需要杀掉之前的压测进程，再启动新的压测，如果一个一个的找出来并杀掉进程，不仅操作复杂而且经常
会产生僵尸进程。</p>

<p>这时候就需要screen、tmux这样的会话管理工具了，通过screen来统一管理会话，所有的压测进程都被托管在screen里，这样如果需要
关掉所有的压力时，只需要杀掉screen进程就可以了。</p>

<p>例：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>screen -S stress -d -m stress-ng -c 1 --timeout 300</span></code></pre></td></tr></table></div></figure>


<h2>1.4. 负载场景剧本设计-playbook</h2>

<p>在云计算场景下，经常会需要用压测工具来模拟一些业务场景，stress-ng是最常用到的工具之一，通常ansible+stress-ng就能应付绝大多数的压测场景。
如果需要模拟的CPU、MEM、磁盘IO模型比较多，用命令行就显得不是那么方便了，这时候就可以用playbook。</p>

<p>github上已经有人写好了一个playbook，<a href="https://github.com/CSCfi/ansible-role-stress">ansible-role-stress</a>。</p>

<p>项目已经在CenstOS 7上测试过了，在Ubuntu上应该也是可以正常工作的。</p>

<p>playbook支持如下角色变量：</p>

<ul>
<li>test_duration: stress-ng 超时时间</li>
<li>不同类型压测资源的worker数量:

<ul>
<li>cpu_workers</li>
<li>vm_workers</li>
<li>hdd_workers</li>
</ul>
</li>
<li>每个worker的磁盘或内存使用量

<ul>
<li>bytes_per_hdd_worker</li>
<li>bytes_per_vm_worker</li>
</ul>
</li>
</ul>


<h2>1.5. 自动重试-ansile经常不靠谱</h2>

<p>使用playbook操作大量机器时，经常会出现机器执行命令失败，比如网络不通、网络闪断等，这时候需要对失败的机器重新执行命令，playbook可以如下命令进行重试</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ansible-playbook -i host stress.yml --extra-vars "host=all" --limit @$playbook_retry</span></code></pre></td></tr></table></div></figure>


<p>其中playbook_retry文件里保存的是需要重试的IP列表,可以从执行回显中分析执行结果，通过awk找出执行失败
的IP列表，通过ansible-playbook进行重试。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/sh
</span><span class='line'>
</span><span class='line'>hosts=(
</span><span class='line'>"host1" 
</span><span class='line'>"host2" 
</span><span class='line'>"host3"
</span><span class='line'>)
</span><span class='line'>
</span><span class='line'>cpu_load=(15 15 15 15 15 15)
</span><span class='line'>mem_load=(5 5 5 5 5 5)
</span><span class='line'>
</span><span class='line'>mkdir -p tmp
</span><span class='line'>
</span><span class='line'>host_file="./hosts"
</span><span class='line'>
</span><span class='line'>total_result="./tmp/total_result.log"
</span><span class='line'>playbook_result="./tmp/playbook_result.log"
</span><span class='line'>playbook_retry="./tmp/playbook_retry.txt"
</span><span class='line'>
</span><span class='line'>echo "" &gt; $total_result
</span><span class='line'>
</span><span class='line'>parse_playbook_result()
</span><span class='line'>{
</span><span class='line'>  sed '1,/PLAY RECAP/d' $playbook_result | awk -F" *|=|\t" '
</span><span class='line'>  /unreachable/{
</span><span class='line'>  ip=$1
</span><span class='line'>  ok_cnt=$4
</span><span class='line'>  changed_cnt=$6
</span><span class='line'>  unreachable_cnt=$8
</span><span class='line'>  failed_cnt=$10
</span><span class='line'>  if(unreachable_cnt!=0 || failed_cnt!=0 || rescued_cnt!=0){
</span><span class='line'>      print ip
</span><span class='line'>  }
</span><span class='line'>  }' &gt; $playbook_retry
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>ansible_playbook()
</span><span class='line'>{
</span><span class='line'>  echo "playbook Vars: $2"
</span><span class='line'>  ansible-playbook -i $host_file $1 --extra-vars "$2" &gt;$playbook_result 2&gt;&1
</span><span class='line'>
</span><span class='line'>  cat $playbook_result &gt; $total_result
</span><span class='line'>  
</span><span class='line'>  while true
</span><span class='line'>  do
</span><span class='line'>      parse_playbook_result
</span><span class='line'>      RETRY_CNT=$(wc -l $playbook_retry | awk '{print $1}')
</span><span class='line'>      
</span><span class='line'>      if [[ $RETRY_CNT != 0 ]]; then
</span><span class='line'>          echo "Some host will retry:"
</span><span class='line'>          cat $playbook_retry
</span><span class='line'>          ansible-playbook -i $host_file stress_stop.yml --extra-vars "$2" --limit @$playbook_retry &gt;/dev/null 2&gt;&1
</span><span class='line'>          ansible-playbook -i $host_file $1 --extra-vars "$2" --limit @$playbook_retry &gt;$playbook_result 2&gt;&1
</span><span class='line'>          cat $playbook_result &gt; $total_result
</span><span class='line'>      else
</span><span class='line'>          return
</span><span class='line'>      fi
</span><span class='line'>  done
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>for(( i=0; i&lt;${#hosts[@]}; i++ ))
</span><span class='line'>do
</span><span class='line'>  echo "Stress" ${hosts[i]}
</span><span class='line'>  ansible_playbook "stress_start.yml" "host=${hosts[i]} cpu_load=${cpu_load[i]} mem_load=${mem_load[i]}"
</span><span class='line'>done
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>echo "Over zzz"
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/05/perf-for-python/">Perf-for-python</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-05T08:44:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>5</span><span class='date-suffix'>th</span>, <span class='date-year'>2020</span></span> <span class='time'>8:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><!-- TOC -->


<ul>
<li><a href="#1-%E5%90%88%E9%80%82%E7%9A%84%E5%B7%A5%E5%85%B7">1. 合适的工具</a>

<ul>
<li><a href="#11-pyflame%E4%BD%BF%E7%94%A8">1.1. pyflame使用</a>

<ul>
<li><a href="#111-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%B9%B6%E6%9E%84%E5%BB%BAdebian-or-ubuntu">1.1.1. 安装依赖并构建（Debian or Ubuntu）</a></li>
<li><a href="#112-%E4%BD%BF%E7%94%A8pyflame">1.1.2. 使用pyflame</a></li>
<li><a href="#113-%E5%88%86%E6%9E%90%E7%BB%93%E6%9E%9C">1.1.3. 分析结果</a></li>
</ul>
</li>
</ul>
</li>
</ul>


<!-- /TOC -->


<p>当前python程序的调试还是比较方便的，不管是用pdb，还是用pycharm的调试IDE（远程的话
可以用远程的SSH解释器来进行调试）都是非常方便的，但是当涉及到需要快速的了解代码热点流程，多线程
程序（其实一般是绿线程或协程），用这种调试方法就比较低效了，这时候可以用perf工具，来
周期性的采集一些python进程的栈信息，从而可以快速的达到上述目的。</p>

<h1>1. 合适的工具</h1>

<p>原始的perf工具，只能跟踪C语言等，或者系统调用等栈信息，如果用来分析python程序的话，
输出的栈信息，会包含python解释器的一些信息，使得栈信息非常不清晰，难以分析。</p>

<p>我们这里用的pyflame工具，进行python的栈信息采样，<code>https://github.com/uber-archive/pyflame/tree/v1.6.6</code></p>

<h2>1.1. pyflame使用</h2>

<h3>1.1.1. 安装依赖并构建（Debian or Ubuntu）</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sudo apt-get install autoconf automake autotools-dev g++ pkg-config python-dev python3-dev libtool make
</span><span class='line'>Once you have the build dependencies installed:
</span><span class='line'>
</span><span class='line'>./autogen.sh
</span><span class='line'>./configure
</span><span class='line'>make</span></code></pre></td></tr></table></div></figure>


<h3>1.1.2. 使用pyflame</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># Attach to PID 12345 and profile it for 1 second
</span><span class='line'>pyflame -p 12345
</span><span class='line'>
</span><span class='line'># Attach to PID 768 and profile it for 5 seconds, sampling every 0.01 seconds
</span><span class='line'>pyflame -s 5 -r 0.01 -p 768
</span><span class='line'>
</span><span class='line'># Run py.test against tests/, emitting sample data to prof.txt
</span><span class='line'>pyflame -o prof.txt -t py.test tests/</span></code></pre></td></tr></table></div></figure>


<h3>1.1.3. 分析结果</h3>

<p>可以使用flamegraph.pl对采集的Prof.txt结果进行解析，flamegraph.pl是一个火焰图生成工具，
可以从如下地址下载。<code>https://raw.githubusercontent.com/brendangregg/FlameGraph/master/flamegraph.pl</code></p>

<p>利用如下命令可以讲pyflame生成的结果转换为火焰图：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>./flamegraph.pl prof.txt &gt; prof.svg</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/01/01/cntlm/">Cntlm</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2020-01-01T08:44:00+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>1</span><span class='date-suffix'>st</span>, <span class='date-year'>2020</span></span> <span class='time'>8:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><!-- TOC -->


<ul>
<li><a href="#1-%E4%BB%A3%E7%90%86%E7%B1%BB%E5%9E%8B">1. 代理类型</a></li>
<li><a href="#2-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">2. 代理服务器</a>

<ul>
<li><a href="#21-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">2.1. 代理服务器主要功能</a></li>
<li><a href="#22-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%89%B9%E6%80%A7%E5%88%86%E7%B1%BB">2.2. 代理服务器的特性分类</a>

<ul>
<li><a href="#221-%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">2.2.1. 正向代理服务器</a></li>
<li><a href="#222-%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">2.2.2. 反向代理服务器</a></li>
<li><a href="#223-%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">2.2.3. 透明代理服务器</a></li>
</ul>
</li>
<li><a href="#23-%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9A%84%E7%94%A8%E9%80%94%E5%88%86%E7%B1%BB">2.3. 代理服务器的用途分类</a>

<ul>
<li><a href="#231-http%E4%BB%A3%E7%90%86">2.3.1. Http代理</a></li>
<li><a href="#232-ssl%E4%BB%A3%E7%90%86">2.3.2. SSL代理</a></li>
<li><a href="#233-http-connect%E4%BB%A3%E7%90%86">2.3.3. HTTP CONNECT代理</a></li>
<li><a href="#234-ftp%E4%BB%A3%E7%90%86">2.3.4. FTP代理</a></li>
<li><a href="#235-pop3%E4%BB%A3%E7%90%86">2.3.5. POP3代理</a></li>
<li><a href="#236-telnet%E4%BB%A3%E7%90%86">2.3.6. Telnet代理</a></li>
<li><a href="#237-socks%E4%BB%A3%E7%90%86">2.3.7. Socks代理</a></li>
<li><a href="#238-tunnel%E4%BB%A3%E7%90%86">2.3.8. TUNNEL代理</a></li>
<li><a href="#239-%E6%96%87%E7%8C%AE%E4%BB%A3%E7%90%86">2.3.9. 文献代理</a></li>
<li><a href="#2310-%E6%95%99%E8%82%B2%E7%BD%91%E4%BB%A3%E7%90%86">2.3.10. 教育网代理</a></li>
<li><a href="#2311-%E8%B7%B3%E6%9D%BF%E4%BB%A3%E7%90%86">2.3.11. 跳板代理</a></li>
<li><a href="#2312-ssso%E4%BB%A3%E7%90%86">2.3.12. Ssso代理</a></li>
<li><a href="#2313-flat%E4%BB%A3%E7%90%86">2.3.13. Flat代理</a></li>
<li><a href="#2314-softe%E4%BB%A3%E7%90%86">2.3.14. SoftE代理</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-%E5%B8%B8%E7%94%A8%E7%9A%84%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8">3. 常用的代理服务器</a>

<ul>
<li><a href="#31-shadowsocks">3.1. shadowsocks</a></li>
<li><a href="#32-shuttle">3.2. shuttle</a></li>
<li><a href="#33-cntlm">3.3. cntlm</a>

<ul>
<li><a href="#331-cntlm%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE">3.3.1. cntlm安装配置</a></li>
<li><a href="#332-cntlm%E6%9C%8D%E5%8A%A1%E9%87%8D%E5%90%AF">3.3.2. cntlm服务重启</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#4-%E5%B8%B8%E7%94%A8%E7%9A%84%E4%BB%A3%E7%90%86%E5%AE%A2%E6%88%B7%E7%AB%AF">4. 常用的代理客户端</a></li>
<li><a href="#5-%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5">5. 参考链接</a></li>
</ul>


<!-- /TOC -->


<h1>1. 代理类型</h1>

<h1>2. 代理服务器</h1>

<h2>2.1. 代理服务器主要功能</h2>

<ul>
<li><p>设置用户验证和记帐功能，可按用户进行记帐，没有登记的用户无权通过代理服务器访问Internet网。并对用户的访问时间、访问地点、信息流量进行统计。</p></li>
<li><p>对用户进行分级管理，设置不同用户的访问权限，对外界或内部的Internet地址进行过滤，设置不同的访问权限。</p></li>
<li><p>增加缓冲器(Cache)，提高访问速度，对经常访问的地址创建缓冲区，大大提高热门站点的访问效率。通常代理服务器都设置一个较大的硬盘缓冲区(可能高达几个GB或更大)，当有外界的信息通过时，同时也将其保存到缓冲区中，当其他用户再访问相同的信息时，则直接由缓冲区中取出信息，传给用户，以提高访问速度。</p></li>
<li><p>连接Internet与Internet，充当防火墙(Firewall):因为所有内部网的用户通过代理服务器访问外界时，只映射为一个IP地址，所以外界不能直接访问到内部网；同时可以设置IP地址过滤，限制内部网对外部的访问权限。</p></li>
<li><p>节省IP开销:代理服务器允许使用大量的伪IP地址，节约网上资源，即用代理服务器可以减少对IP地址的需求，对于使用局域网方式接入Internet ，如果为局域网(LAN)内的每一个用户都申请一个IP地址，其费用可想而知。但使用代理服务器后，只需代理服务器上有一个合法的IP地址，LAN内其他用户可以使用10.<em>.</em>.*这样的私有IP地址，这样可以节约大量的IP，降低网络的维护成本。</p></li>
</ul>


<h2>2.2. 代理服务器的特性分类</h2>

<h3>2.2.1. 正向代理服务器</h3>

<p>正向代理服务器位于用户与目标服务器之间，用户通过对代理服务器发送指向目标服务器的请求来获得资源。用户端需要作一些设定才可以使用正向代理服务器，而反向/透明代理服务器是不需要对用户端进行任何设定的。</p>

<h3>2.2.2. 反向代理服务器</h3>

<p>反向代理服务器同样位于用户与目标服务器之间，但对于用户而言，反向代理服务器就相当于目标服务器，即用户直接访问反向代理服务器就可以获得目标服务器的资源。同时，用户不需要知道目标服务器地址，也无需在用户端作任何设定。反向代理服务器通常可用来作Web加速，即使用反向代理作为Web服务器的前置机来降低网络和服务器的负载，提高访问效率。</p>

<h3>2.2.3. 透明代理服务器</h3>

<p>透明代理服务器位于于用户与目标服务器之间.和前两种服务器不同的是，用户即不需要对客户端进行任何设定，也无需知道代理服务器的地址。用户只需要向目标服务器上的资源发起请求即可，然后透明代理服务器会将系统的请求重新定向到代理服务器，然后由代理服务器获得目标资源并返回给用户端。通常，透明代理服务器在局域网中应用。</p>

<h2>2.3. 代理服务器的用途分类</h2>

<h3>2.3.1. Http代理</h3>

<p>代理客户机的http访问，主要代理浏览器访问网页，它的端口一般为80、8080、3128等。</p>

<h3>2.3.2. SSL代理</h3>

<p>支持最高128位加密强度的http代理，可以作为访问加密网站的代理。加密网站是指以<a href="https://%E5%BC%80%E5%A7%8B%E7%9A%84%E7%BD%91%E7%AB%99%E3%80%82ssl%E7%9A%84%E6%A0%87%E5%87%86%E7%AB%AF%E5%8F%A3%E4%B8%BA443%E3%80%82">https://%E5%BC%80%E5%A7%8B%E7%9A%84%E7%BD%91%E7%AB%99%E3%80%82ssl%E7%9A%84%E6%A0%87%E5%87%86%E7%AB%AF%E5%8F%A3%E4%B8%BA443%E3%80%82</a></p>

<h3>2.3.3. HTTP CONNECT代理</h3>

<p>允许用户建立TCP连接到任何端口的代理服务器，这种代理不仅可用于HTTP，还包括FTP、IRC、RM流服务等。</p>

<h3>2.3.4. FTP代理</h3>

<p>代理客户机上的ftp软件访问ftp服务器，其端口一般为21、2121。</p>

<h3>2.3.5. POP3代理</h3>

<p>代理客户机上的邮件软件用pop3方式收邮件，其端口一般为110。</p>

<h3>2.3.6. Telnet代理</h3>

<p>能够代理通信机的telnet，用于远程控制，入侵时经常使用。其端口一般为23。</p>

<h3>2.3.7. Socks代理</h3>

<p>是全能代理，就像有很多跳线的转接板，它只是简单地将一端的系统连接到另外一端。支持多种协议，包括http、ftp请求及其它类型的请求。它分socks 4 和socks 5两种类型，socks 4只支持TCP协议而socks 5支持TCP/UDP协议，还支持各种身份验证机制等协议。其标准端口为1080。</p>

<h3>2.3.8. TUNNEL代理</h3>

<p>经HTTPTunnet程序转换的数据包封装成http请求（Request）来穿透防火墙，允许利用HTTP服务器做任何TCP可以做的事情，功能相当于Socks5。</p>

<h3>2.3.9. 文献代理</h3>

<p>可以用来查询数据库的代理，通过这些代理，可以获得互联网的相关科研学术的数据库资源，例如查询Sciencedirect网站（简称SD）、Academic Press、IEEE，SPRINGER等数据库。</p>

<h3>2.3.10. 教育网代理</h3>

<p>指学术教育机构局域网通过特定的代理服务器可使无出国权限或无访问某IP段权限的计算机访问相关资源。</p>

<h3>2.3.11. 跳板代理</h3>

<p>应用于跳板程序，可以看作一种具有动态加密的特殊socks5代理，，也可直接用于PSD软件。其端口一般为1813。</p>

<h3>2.3.12. Ssso代理</h3>

<p>代理客户机上的ssso程序访问远程网站，具有SSL加密强度的超级代理，支持socks。</p>

<h3>2.3.13. Flat代理</h3>

<p>代理客户机上的flatsurfer程序访问远程网站，具有高强度加密数据流的特殊代理，支持socks，最大可设置三次级联，可以设置穿越代理。其端口一般为6700。</p>

<h3>2.3.14. SoftE代理</h3>

<p>代理客户机上的SoftEther程序访问远程网站，应用虚拟集线器HUB和虚拟网卡技术，具备VPN功能及多种认证方式的代理，符合https协议。</p>

<h1>3. 常用的代理服务器</h1>

<h2>3.1. shadowsocks</h2>

<h2>3.2. shuttle</h2>

<h2>3.3. cntlm</h2>

<p>NTLM是微软开发的http代理鉴权验证协议，只有原生支持NTLMv2鉴权协议的软件才能使用其代理服务，Cntlm是一款C开发的支持NTLM协议鉴权，并作为中间代理服务器，未其它
软件、OS提供代理服务的软件。</p>

<h3>3.3.1. cntlm安装配置</h3>

<p>常用的代理配置如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Username test_user
</span><span class='line'>Domain        test_domain
</span><span class='line'>Password  test_password
</span><span class='line'>
</span><span class='line'>Proxy     proxy.xxx.com:8080
</span><span class='line'>
</span><span class='line'>NoProxy     127.0.0.1
</span><span class='line'>
</span><span class='line'>Listen        3128
</span><span class='line'>
</span><span class='line'>Allow     0/0
</span><span class='line'>
</span><span class='line'>Deny      0/0</span></code></pre></td></tr></table></div></figure>


<p>需要配置鉴权HASH信息，可以通过如下命令获取，</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>C:\Program Files (x86)\Cntlm&gt;cntlm.exe -M  https://www.baidu.com
</span><span class='line'>      0 [main] cntlm 48032 find_fast_cwd: WARNING: Couldn't compute FAST_CWD pointer.  Please report this problem to
</span><span class='line'>the public mailing list cygwin@cygwin.com
</span><span class='line'>cygwin warning:
</span><span class='line'>  MS-DOS style path detected: C:\Program Files (x86)\Cntlm\cntlm.ini
</span><span class='line'>  Preferred POSIX equivalent is: /Cntlm/cntlm.ini
</span><span class='line'>  CYGWIN environment variable option "nodosfilewarning" turns off this warning.
</span><span class='line'>  Consult the user's guide for more details about POSIX paths:
</span><span class='line'>    http://cygwin.com/cygwin-ug-net/using.html#using-pathnames
</span><span class='line'>Password:
</span><span class='line'>Config profile  1/4... Credentials rejected
</span><span class='line'>Config profile  2/4... OK (HTTP code: 500)
</span><span class='line'>----------------------------[ Profile  1 ]------
</span><span class='line'>Auth            NTLM
</span><span class='line'>PassNT          454D349D302XXXXXXXXXXXXXXXXXXXX9
</span><span class='line'>PassLM          052764B974CXXXXXXXXXXXXXXXXXXXXC
</span><span class='line'>------------------------------------------------</span></code></pre></td></tr></table></div></figure>


<p>拷贝如下三行到配置文件</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Auth            NTLM
</span><span class='line'>PassNT          454D349D302XXXXXXXXXXXXXXXXXXXX9
</span><span class='line'>PassLM          052764B974CXXXXXXXXXXXXXXXXXXXXC</span></code></pre></td></tr></table></div></figure>


<ul>
<li>注意：</li>
</ul>


<p>如果配置cntlm代理，需要把ie浏览器里的局域网代理，也切换到cntlm的本地地址上，如127.0.0.1：:3128</p>

<h3>3.3.2. cntlm服务重启</h3>

<ul>
<li>Windows</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>net stop cntlm
</span><span class='line'>net start cntlm</span></code></pre></td></tr></table></div></figure>


<ul>
<li>Linux</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>apt-get install cntlm
</span><span class='line'>systemclt restart cntlm</span></code></pre></td></tr></table></div></figure>


<h1>4. 常用的代理客户端</h1>

<h1>5. 参考链接</h1>

<p><a href="https://blog.csdn.net/ysdaniel/article/details/6999276">https://blog.csdn.net/ysdaniel/article/details/6999276</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/12/26/iptables-examples-port-forward/">Iptables Examples</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-12-26T08:44:00+00:00'><span class='date'><span class='date-month'>Dec</span> <span class='date-day'>26</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>8:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><!-- TOC -->


<ul>
<li><a href="#1-iptables%E5%91%BD%E4%BB%A4%E7%AE%80%E4%BB%8B">1. iptables命令简介</a></li>
<li><a href="#2-%E8%AF%AD%E6%B3%95">2. 语法</a>

<ul>
<li><a href="#21-%E9%80%89%E9%A1%B9">2.1. 选项</a></li>
<li><a href="#22-%E5%91%BD%E4%BB%A4%E8%A7%A3%E9%87%8A">2.2. 命令解释</a>

<ul>
<li><a href="#221-%E8%A1%A8%E5%90%8D">2.2.1. 表名</a></li>
</ul>
</li>
<li><a href="#23-%E5%A4%87%E4%BB%BD%E7%B3%BB%E7%BB%9F%E7%8E%B0%E6%9C%89%E7%9A%84%E8%A7%84%E5%88%99">2.3. 备份系统现有的规则</a></li>
<li><a href="#24-%E6%81%A2%E5%A4%8D%E7%B3%BB%E7%BB%9F%E5%A4%87%E4%BB%BD%E7%9A%84%E8%A7%84%E5%88%99">2.4. 恢复系统备份的规则</a></li>
<li><a href="#25-%E4%BF%9D%E5%AD%98%E8%A7%84%E5%88%99">2.5. 保存规则</a></li>
<li><a href="#26-%E5%BC%80%E6%94%BE%E6%89%80%E6%9C%89%E7%AB%AF%E5%8F%A3">2.6. 开放所有端口</a></li>
</ul>
</li>
</ul>


<!-- /TOC -->


<p>linux命令之iptables</p>

<h1>1. iptables命令简介</h1>

<p>iptables命令是Linux上常用的防火墙软件，是netfilter项目的一部分。可以直接配置，也可以通过许多前端和图形界面配置。它可以用来过滤、阻塞不需要的流量，允许正常的网络流浪通行。</p>

<h1>2. 语法</h1>

<p>iptables(选项)(参数)</p>

<h2>2.1. 选项</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>-t&lt;表&gt;：指定要操纵的表；
</span><span class='line'>-A：向规则链中添加条目；
</span><span class='line'>-D：从规则链中删除条目；
</span><span class='line'>-i：向规则链中插入条目；
</span><span class='line'>-R：替换规则链中的条目；
</span><span class='line'>-L：显示规则链中已有的条目；
</span><span class='line'>-F：清楚规则链中已有的条目；
</span><span class='line'>-Z：清空规则链中的数据包计算器和字节计数器；
</span><span class='line'>-N：创建新的用户自定义规则链；
</span><span class='line'>-P：定义规则链中的默认目标；
</span><span class='line'>-h：显示帮助信息；
</span><span class='line'>-p：指定要匹配的数据包协议类型；
</span><span class='line'>-s：指定要匹配的数据包源ip地址；
</span><span class='line'>-j&lt;目标&gt;：指定要跳转的目标；
</span><span class='line'>-i&lt;网络接口&gt;：指定数据包进入本机的网络接口；
</span><span class='line'>-o&lt;网络接口&gt;：指定数据包要离开本机所使用的网络接口。</span></code></pre></td></tr></table></div></figure>


<h2>2.2. 命令顺序</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -t 表名 &lt;-A/I/D/R&gt; 规则链名 [规则号] &lt;-i/o 网卡名&gt; -p 协议名 &lt;-s 源IP/源子网&gt; --sport 源端口 &lt;-d 目标IP/目标子网&gt; --dport 目标端口 -j 动作</span></code></pre></td></tr></table></div></figure>


<h2>2.2. 命令解释</h2>

<h3>2.2.1. 表名</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>raw：高级功能，如：网址过滤。
</span><span class='line'>mangle：数据包修改（QOS），用于实现服务质量。
</span><span class='line'>net：地址转换，用于网关路由器。
</span><span class='line'>filter：包过滤，用于防火墙规则。</span></code></pre></td></tr></table></div></figure>


<h3>2.3.2. 规则链名</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INPUT链：处理输入数据包。
</span><span class='line'>OUTPUT链：处理输出数据包。
</span><span class='line'>PORWARD链：处理转发数据包。
</span><span class='line'>PREROUTING链：用于目标地址转换（DNAT）。
</span><span class='line'>POSTOUTING链：用于源地址转换（SNAT）。</span></code></pre></td></tr></table></div></figure>


<h3>2.3.3. 动作</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>accept：接收数据包。
</span><span class='line'>drop：丢弃数据包。
</span><span class='line'>redirct：重定向、映射、透明代理。
</span><span class='line'>snat：源地址转换。
</span><span class='line'>dnat：目标地址转换。
</span><span class='line'>masquerade：IP伪装（NAT），用于ADSL。
</span><span class='line'>log：日志记录。</span></code></pre></td></tr></table></div></figure>


<h1>3. 常用命令</h1>

<h2>3.1. 开放指定的端口</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -A INPUT -s 127.0.0.1 -d 127.0.0.1 -j ACCEPT               #允许本地回环接口(即运行本机访问本机)
</span><span class='line'>iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT    #允许已建立的或相关连的通行
</span><span class='line'>iptables -A OUTPUT -j ACCEPT         #允许所有本机向外的访问
</span><span class='line'>iptables -A INPUT -p tcp --dport 22 -j ACCEPT    #允许访问22端口
</span><span class='line'>iptables -A INPUT -p tcp --dport 80 -j ACCEPT    #允许访问80端口
</span><span class='line'>iptables -A INPUT -p tcp --dport 21 -j ACCEPT    #允许ftp服务的21端口
</span><span class='line'>iptables -A INPUT -p tcp --dport 20 -j ACCEPT    #允许FTP服务的20端口
</span><span class='line'>iptables -A INPUT -j reject       #禁止其他未允许的规则访问
</span><span class='line'>iptables -A FORWARD -j REJECT     #禁止其他未允许的规则访问</span></code></pre></td></tr></table></div></figure>


<h2>3.2. 屏蔽IP</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -I INPUT -s 123.45.6.7 -j DROP       #屏蔽单个IP的命令
</span><span class='line'>iptables -I INPUT -s 123.0.0.0/8 -j DROP      #封整个段即从123.0.0.1到123.255.255.254的命令
</span><span class='line'>iptables -I INPUT -s 124.45.0.0/16 -j DROP    #封IP段即从123.45.0.1到123.45.255.254的命令
</span><span class='line'>iptables -I INPUT -s 123.45.6.0/24 -j DROP    #封IP段即从123.45.6.1到123.45.6.254的命令是</span></code></pre></td></tr></table></div></figure>


<h2>3.3. 查看已添加的iptables规则</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -L -n -v
</span><span class='line'>
</span><span class='line'>Chain INPUT (policy DROP 48106 packets, 2690K bytes)
</span><span class='line'> pkts bytes target     prot opt in     out     source               destination         
</span><span class='line'> 5075  589K ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
</span><span class='line'> 191K   90M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:22
</span><span class='line'>1499K  133M ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0           tcp dpt:80
</span><span class='line'>4364K 6351M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0           state RELATED,ESTABLISHED
</span><span class='line'> 6256  327K ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           
</span><span class='line'>
</span><span class='line'>Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
</span><span class='line'> pkts bytes target     prot opt in     out     source               destination         
</span><span class='line'>
</span><span class='line'>Chain OUTPUT (policy ACCEPT 3382K packets, 1819M bytes)
</span><span class='line'> pkts bytes target     prot opt in     out     source               destination         
</span><span class='line'> 5075  589K ACCEPT     all  --  *      lo      0.0.0.0/0            0.0.0.0/0  </span></code></pre></td></tr></table></div></figure>


<h2>3.4. 删除已添加的iptables规则</h2>

<p>将所有iptables以序号标记显示，执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -L -n --line-numbers</span></code></pre></td></tr></table></div></figure>


<p>比如要删除INPUT里序号为8的规则，执行：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -D INPUT 8</span></code></pre></td></tr></table></div></figure>


<h2>2.3. 备份系统现有的规则</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables-save &gt; iptables.rules</span></code></pre></td></tr></table></div></figure>


<h2>2.4. 恢复系统备份的规则</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables-restore &lt; iptables.rules</span></code></pre></td></tr></table></div></figure>


<h2>2.5. 保存规则</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>service iptables save</span></code></pre></td></tr></table></div></figure>


<h2>2.6. 开放所有端口</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -P INPUT ACCEPT   
</span><span class='line'>iptables -P OUTPUT ACCEPT  </span></code></pre></td></tr></table></div></figure>


<h2>3.9. 端口转发</h2>

<h3>3.9.1. 同一端口转发</h3>

<p>(192.168.0.132上开通1521端口访问 iptables -A RH-Firewall-1-INPUT -m state &ndash;state NEW -m tcp -p tcp &ndash;dport 1521 -j ACCEPT)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -t nat -I PREROUTING -p tcp --dport 1521 -j DNAT --to 192.168.0.211
</span><span class='line'>iptables -t nat -I POSTROUTING -p tcp --dport 1521 -j MASQUERADE</span></code></pre></td></tr></table></div></figure>


<h3>3.9.2. 不同端口转发</h3>

<p>(192.168.0.132上开通21521端口访问 iptables -A RH-Firewall-1-INPUT -m state &ndash;state NEW -m tcp -p tcp &ndash;dport 21521 -j ACCEPT)</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -t nat -A PREROUTING -p tcp -m tcp --dport21521 -j DNAT --to-destination192.168.0.211:1521
</span><span class='line'>iptables -t nat -A POSTROUTING -s 192.168.0.0/16 -d 192.168.0.211 -p tcp -m tcp --dport 1521 -j SNAT --to-source 192.168.0.132</span></code></pre></td></tr></table></div></figure>


<h3>3.9.3. 以上两条等价配置(更简单[指定网卡]):</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 31521 -j DNAT --to 192.168.0.211:1521
</span><span class='line'>iptables -t nat -A POSTROUTING -j MASQUERADE</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/07/13/iptables-packets-flow/">Iptables Packets Flow</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-07-13T12:32:33+00:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>12:32 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>之前在网上看到一张iptables的数据包路径决策图,在这里收藏一下,原始地址找不到了^-^,这里就不写转载链接了,如果作者看到,可以提醒我一下,多谢</p>

<p><img src="https://raw.githubusercontent.com/iskey/iskey.github.io/source/source/images/blogs/iptables_packet_flow.png" alt="iptables_packets_flow" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/07/13/win-sshfs/">Win Sshfs</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-07-13T11:46:51+00:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>11:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>背景</h4>

<p>代码开发时，有时候必须要把代码拷贝到远程的主机上去执行，这时候大部分我们会用ssh登上去，用vim修改，但是如果改的代码比较多，对于不太习惯vim的同学，就会觉得比较累。这时候一般的做法是在本地用编辑器（SourceInsighet/PyCharm）等修改代码，然后再传到服务器上去。[Pycharm专业版可以上传到ssh远端哦~]</p>

<p>这里推荐一个开源的win-sshfs工具，可以利用ssh在本地建立一个远端的目录映射，将ssh远端服务器的目录映射成本地的一个目录，这样就可以直接利用本地丰富的编辑器来改代码了，改完之后，直接在远端执行就可以了。</p>

<h4>win-sshfs下载、安装</h4>

<p>首先需要下载dokan和win-sshfs，dokan提供win-sshfs需要的驱动和库文件，下载的时候一定要注意版本问题~，<a href="https://github.com/feo-cz/win-sshfs/releases">win-sshfs Releases</a>,在下载链接里一遍会标注推荐的dokan版本号。
我这里用的是<a href="https://github.com/dokan-dev/dokany/releases/tag/v1.0.5">DokanSetup_redist-1.0.5.1000</a>和<a href="https://github.com/feo-cz/win-sshfs/releases/tag/1.6.1">WinSSHFS-1.6.1.13-devel</a></p>

<h4>使用</h4>

<p>UI界面很容易看懂，mount之后，就会在本地多一个磁盘出来，操作磁盘里的文件，就相当于操作远程ssh服务器上的文件。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/07/13/simple-example-of-rabbitmq/">Simple Example of Rabbitmq</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-07-13T11:45:27+00:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>11:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>关于python的queue介绍
关于python的队列，内置的有两种，一种是线程queue，另一种是进程queue，但是这两种queue都是只能在同一个进程下的线程间或者父进程与子进程之间进行队列通讯，并不能进行程序与程序之间的信息交换，这时候我们就需要一个中间件，来实现程序之间的通讯。</p>

<h2>RabbitMQ</h2>

<p>MQ并不是python内置的模块，而是一个需要你额外安装（ubuntu可直接apt-get其余请自行百度。）的程序，安装完毕后可通过python中内置的pika模块来调用MQ发送或接收队列请求。接下来我们就看几种python调用MQ的模式（作者自定义中文形象的模式名称）与方法。</p>

<h3>RabbitMQ设置远程链接账号密码</h3>

<p>启动rabbitmq web服务：
远程访问rabbitmq:自己增加一个用户，步骤如下：
- 创建一个admin用户：sudo rabbitmqctl add_user admin 123123
- 设置该用户为administrator角色：sudo rabbitmqctl set_user_tags admin administrator
- 设置权限：sudo rabbitmqctl  set_permissions  -p  &lsquo;/&rsquo;  admin &lsquo;.&rsquo; &lsquo;.&rsquo; &lsquo;.&rsquo;
- 重启rabbitmq服务：sudo service rabbitmq-server restart
之后就能用admin用户远程连接rabbitmq server了。</p>

<h3>轮询消费模式</h3>

<p>此模式下，发送队列的一方把消息存入mq的指定队列后，若有消费者端联入相应队列，即会获取到消息，并且队列中的消息会被消费掉。</p>

<p>若有多个消费端同时连接着队列，则会已轮询的方式将队列中的消息消费掉。</p>

<p>接下来是代码实例：</p>

<h4>producer生产者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># !/usr/bin/env python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 声明queue</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">&#39;balance&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># n RabbitMQ a message can never be sent directly to the queue, it always needs to go through an exchange.</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">routing_key</span><span class="o">=</span><span class="s">&#39;balance&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">body</span><span class="o">=</span><span class="s">&#39;Hello World!&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] Sent &#39;Hello World!&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>发送过队列后，可在MQ服务器中查看队列状态</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c"># rabbitmqctl list_queues</span>
</span><span class='line'><span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
</span><span class='line'><span class="n">hello</span>    <span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<h4>consumer消费者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># _*_coding:utf-8_*_</span>
</span><span class='line'><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Alex Li&#39;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># You may ask why we declare the queue again ‒ we have already declared it in our previous code.</span>
</span><span class='line'><span class="c"># We could avoid that if we were sure that the queue already exists. For example if send.py program</span>
</span><span class='line'><span class="c"># was run before. But we&#39;re not yet sure which program to run first. In such cases it&#39;s a good</span>
</span><span class='line'><span class="c"># practice to repeat declaring the queue in both programs.</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">&#39;balance&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] Received </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">queue</span><span class="o">=</span><span class="s">&#39;balance&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">no_ack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39; [*] Waiting for messages. To exit press CTRL+C&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>接收队列后，查看一下队列状态</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c">#  rabbitmqctl list_queues</span>
</span><span class='line'><span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
</span><span class='line'><span class="n">hello</span>    <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<h3>队列持久化</h3>

<p>当rabbitMQ意外宕机时，可能会有持久化保存队列的需求（队列中的消息不消失）。</p>

<h4>producer生产者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># !/usr/bin/env python</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># 声明queue</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">&#39;durable&#39;</span><span class="p">,</span><span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># n RabbitMQ a message can never be sent directly to the queue, it always needs to go through an exchange.</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">routing_key</span><span class="o">=</span><span class="s">&#39;durable&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">body</span><span class="o">=</span><span class="s">&#39;Hello cheng!&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">properties</span><span class="o">=</span><span class="n">pika</span><span class="o">.</span><span class="n">BasicProperties</span><span class="p">(</span>
</span><span class='line'>                          <span class="n">delivery_mode</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>  <span class="c"># make message persistent</span>
</span><span class='line'>                      <span class="p">)</span>
</span><span class='line'>                      <span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] Sent &#39;Hello cheng!&#39;&quot;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>执行后查看队列，记下队列名字与队列中所含消息的数量</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c"># rabbitmqctl list_queues</span>
</span><span class='line'><span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
</span><span class='line'><span class="n">durable</span>    <span class="mi">1</span>
</span><span class='line'><span class="c">#重启rabbitmq</span>
</span><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c"># systemctl restart rabbitmq-server</span>
</span><span class='line'><span class="c">#重启完毕后再次查看</span>
</span><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c"># rabbitmqctl list_queues</span>
</span><span class='line'><span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
</span><span class='line'><span class="n">durable</span>   <span class="c">#队列以及消息并未消失</span>
</span></code></pre></td></tr></table></div></figure>


<h4>consumer消费者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># _*_coding:utf-8_*_</span>
</span><span class='line'><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Alex Li&#39;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="c"># You may ask why we declare the queue again ‒ we have already declared it in our previous code.</span>
</span><span class='line'><span class="c"># We could avoid that if we were sure that the queue already exists. For example if send.py program</span>
</span><span class='line'><span class="c"># was run before. But we&#39;re not yet sure which program to run first. In such cases it&#39;s a good</span>
</span><span class='line'><span class="c"># practice to repeat declaring the queue in both programs.</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="s">&#39;durable&#39;</span><span class="p">,</span><span class="n">durable</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] Received </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="n">ch</span><span class="o">.</span><span class="n">basic_ack</span><span class="p">(</span><span class="n">delivery_tag</span><span class="o">=</span><span class="n">method</span><span class="o">.</span><span class="n">delivery_tag</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">queue</span><span class="o">=</span><span class="s">&#39;durable&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="c">#no_ack=True</span>
</span><span class='line'>                      <span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39; [*] Waiting for messages. To exit press CTRL+C&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>可正确接收到信息。</p>

<p>再次查看队列的情况。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="p">[</span><span class="n">root</span><span class="nd">@localhost</span> <span class="o">~</span><span class="p">]</span><span class="c"># rabbitmqctl list_queues</span>
</span><span class='line'><span class="n">Listing</span> <span class="n">queues</span> <span class="o">...</span>
</span><span class='line'><span class="n">durable</span>    <span class="mi">0</span>
</span></code></pre></td></tr></table></div></figure>


<h3>广播模式</h3>

<p>当producer发送消息到队列后，所有的consumer都会收到消息，需要注意的是，此模式下producer与concerned之间的关系类似与广播电台与收音机，如果广播后收音机没有接受到，那么消息就会丢失。</p>

<p>建议先执行consumer</p>

<h4>consumer生产者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># _*_coding:utf-8_*_</span>
</span><span class='line'><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Alex Li&#39;</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;Clogs&#39;</span><span class="p">,</span>
</span><span class='line'>                         <span class="nb">type</span><span class="o">=</span><span class="s">&#39;fanout&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="n">exclusive</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c"># 不指定queue名字,rabbit会随机分配一个名字,exclusive=True会在使用此queue的消费者断开后,自动将queue删除</span>
</span><span class='line'><span class="n">queue_name</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;Clogs&#39;</span><span class="p">,</span>
</span><span class='line'>                   <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39; [*] Waiting for logs. To exit press CTRL+C&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">properties</span><span class="p">,</span> <span class="n">body</span><span class="p">):</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">body</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_consume</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">no_ack</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">start_consuming</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h4>producer生产者</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">pika</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">sys</span>
</span><span class='line'>
</span><span class='line'><span class="n">credentials</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="s">&#39;admin&#39;</span><span class="p">,</span><span class="s">&#39;123456&#39;</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">BlockingConnection</span><span class="p">(</span><span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;192.168.56.19&#39;</span><span class="p">,</span><span class="mi">5672</span><span class="p">,</span><span class="s">&#39;/&#39;</span><span class="p">,</span><span class="n">credentials</span><span class="p">))</span>
</span><span class='line'><span class="n">channel</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;Clogs&#39;</span><span class="p">,</span>
</span><span class='line'>                         <span class="nb">type</span><span class="o">=</span><span class="s">&#39;fanout&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">message</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="ow">or</span> <span class="s">&quot;info: Hello World!&quot;</span>
</span><span class='line'><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span><span class="n">exchange</span><span class="o">=</span><span class="s">&#39;Clogs&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">routing_key</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">body</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&quot; [x] Sent </span><span class="si">%r</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
</span><span class='line'><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/07/13/powershell-monitor-dir/">Powershell监控脚本</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-07-13T11:45:27+00:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>11:45 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Powershell监控实用脚本</h1>

<p>标签（空格分隔）： 未分类</p>

<hr />

<h2>监控文件变化</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># 定义要监控的文件夹，这个文件夹必须先存在。
</span><span class='line'>
</span><span class='line'>$folder = 'D:\test'
</span><span class='line'>
</span><span class='line'># 定义每次监控的间隔时间，这时定义为1000毫秒，即1秒
</span><span class='line'>
</span><span class='line'>$timeout = 1000
</span><span class='line'>
</span><span class='line'># 创建文件系统监视对象
</span><span class='line'>
</span><span class='line'>$FileSystemWatcher = New-Object System.IO.FileSystemWatcher $folder
</span><span class='line'>
</span><span class='line'>Write-Host ”按 CTRL+C 来退出对文件夹 $folder 的监控”
</span><span class='line'>
</span><span class='line'>while ($true) {
</span><span class='line'>
</span><span class='line'>  # 监控文件夹内的所有变化
</span><span class='line'>
</span><span class='line'>  $result = $FileSystemWatcher.WaitForChanged('all', $timeout)
</span><span class='line'>
</span><span class='line'>  if ($result.TimedOut -eq $false)
</span><span class='line'>
</span><span class='line'>   {
</span><span class='line'>
</span><span class='line'>   # 当文件夹的内容变化时，发出警告提示
</span><span class='line'>
</span><span class='line'>   Write-Warning ('File {0} : {1}' -f $result.ChangeType, $result.name)
</span><span class='line'>
</span><span class='line'>   }
</span><span class='line'>
</span><span class='line'>} 
</span><span class='line'>
</span><span class='line'>Write-Host '监控被取消.'
</span><span class='line'>    </span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/07/13/sample-of-ipsec/">Usage of IPSec</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2019-07-13T10:25:17+00:00'><span class='date'><span class='date-month'>Jul</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2019</span></span> <span class='time'>10:25 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>前几天用eNSP模拟的实验了一下IPSec的用法,这里简单记录一下</p>

<p><img src="https://raw.githubusercontent.com/iskey/iskey.github.io/source/source/images/blogs/IPSec.png" alt="IPSec" /></p>

<p>交换机基本配置</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>interface g 0/0/0
</span><span class='line'>  ip address 192.168.1.254 24
</span><span class='line'>interface g 0/0/1
</span><span class='line'>  ip address 200.1.1.1 24
</span><span class='line'>firewall zone trust
</span><span class='line'>  add int g 0/0/0
</span><span class='line'>  quit
</span><span class='line'>firewall zone untrust
</span><span class='line'>  add int g 0/0/1
</span><span class='line'>  quit
</span><span class='line'>ip route-static 0.0.0.0 0 200.1.1.2
</span><span class='line'>#
</span><span class='line'>
</span><span class='line'>acl 3000
</span><span class='line'>  rule  permit ip source 192.168.1.0 0.0.0.255 destination 192.168.2.0 0.0.0.255
</span><span class='line'>
</span><span class='line'>####IKE 阶段一  策略
</span><span class='line'>ike proposal 1
</span><span class='line'>  ike proposal 1
</span><span class='line'>  authentication-method pre-share
</span><span class='line'>  authentication-algorithm md5
</span><span class='line'>  encryption-algorithm 3des-cbc
</span><span class='line'>  quit
</span><span class='line'>
</span><span class='line'>####IKE 阶段一 对等体
</span><span class='line'>ike peer fw2 v1
</span><span class='line'>  pre-shared-key simple huawei
</span><span class='line'>  ike-proposal 1
</span><span class='line'>  remote-address 200.2.2.2
</span><span class='line'>
</span><span class='line'>#### IKE阶段二的策略
</span><span class='line'>ipsec proposal myset
</span><span class='line'>  transform esp
</span><span class='line'>  esp authentication-algorithm sha1
</span><span class='line'>  esp encryption-algorithm 3des
</span><span class='line'>
</span><span class='line'>####整合成 ipsec policy
</span><span class='line'>ipsec policy mymap 10 isakmp
</span><span class='line'>  security acl 3000
</span><span class='line'>  ike-peer fw2
</span><span class='line'>  proposal myset
</span><span class='line'>
</span><span class='line'>####使能端口QoS策略
</span><span class='line'>interface g 0/0/1
</span><span class='line'>  ipsec policy mymap
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/2">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/02/08/ovs-qos/">QoS</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/02/02/ansible-stress-scripts/">Ansible-stress</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/05/perf-for-python/">Perf-for-python</a>
      </li>
    
      <li class="post">
        <a href="/blog/2020/01/01/cntlm/">Cntlm</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/12/26/iptables-examples-port-forward/">Iptables Examples</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/ansible/'>ansible (2)</a></li><li><a href='/blog/categories/iptables/'>iptables (4)</a></li><li><a href='/blog/categories/k8s/'>k8s (2)</a></li><li><a href='/blog/categories/kernel/'>kernel (5)</a></li><li><a href='/blog/categories/linux/'>linux (5)</a></li><li><a href='/blog/categories/lvm/'>lvm (1)</a></li><li><a href='/blog/categories/makefile/'>makefile (2)</a></li><li><a href='/blog/categories/mq/'>mq (1)</a></li><li><a href='/blog/categories/netfilter/'>netfilter (1)</a></li><li><a href='/blog/categories/octopress/'>octopress (1)</a></li><li><a href='/blog/categories/ovs/'>ovs (3)</a></li><li><a href='/blog/categories/powershell/'>powershell (1)</a></li><li><a href='/blog/categories/proxy/'>proxy (1)</a></li><li><a href='/blog/categories/python/'>python (2)</a></li><li><a href='/blog/categories/regax/'>regax (1)</a></li><li><a href='/blog/categories/sdn/'>sdn (1)</a></li><li><a href='/blog/categories/shell/'>shell (4)</a></li><li><a href='/blog/categories/socket/'>socket (3)</a></li><li><a href='/blog/categories/sourceinsight/'>sourceinsight (1)</a></li><li><a href='/blog/categories/sysctl/'>sysctl (1)</a></li><li><a href='/blog/categories/systemd/'>systemd (1)</a></li><li><a href='/blog/categories/todo/'>todo (1)</a></li><li><a href='/blog/categories/tool/'>tool (8)</a></li><li><a href='/blog/categories/ubuntu/'>ubuntu (1)</a></li><li><a href='/blog/categories/vim/'>vim (1)</a></li><li><a href='/blog/categories/gong-ju/'>工具 (1)</a></li><li><a href='/blog/categories/shu-tong/'>数通 (1)</a></li><li><a href='/blog/categories/she-ji-mo-shi/'>设计模式 (1)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/ansible' style='font-size: 115.0%'>ansible(2)</a> <a href='/blog/categories/iptables' style='font-size: 130.0%'>iptables(4)</a> <a href='/blog/categories/k8s' style='font-size: 115.0%'>k8s(2)</a> <a href='/blog/categories/kernel' style='font-size: 137.5%'>kernel(5)</a> <a href='/blog/categories/linux' style='font-size: 137.5%'>linux(5)</a> <a href='/blog/categories/lvm' style='font-size: 107.5%'>lvm(1)</a> <a href='/blog/categories/makefile' style='font-size: 115.0%'>makefile(2)</a> <a href='/blog/categories/mq' style='font-size: 107.5%'>mq(1)</a> <a href='/blog/categories/netfilter' style='font-size: 107.5%'>netfilter(1)</a> <a href='/blog/categories/octopress' style='font-size: 107.5%'>octopress(1)</a> <a href='/blog/categories/ovs' style='font-size: 122.5%'>ovs(3)</a> <a href='/blog/categories/powershell' style='font-size: 107.5%'>powershell(1)</a> <a href='/blog/categories/proxy' style='font-size: 107.5%'>proxy(1)</a> <a href='/blog/categories/python' style='font-size: 115.0%'>python(2)</a> <a href='/blog/categories/regax' style='font-size: 107.5%'>regax(1)</a> <a href='/blog/categories/sdn' style='font-size: 107.5%'>sdn(1)</a> <a href='/blog/categories/shell' style='font-size: 130.0%'>shell(4)</a> <a href='/blog/categories/socket' style='font-size: 122.5%'>socket(3)</a> <a href='/blog/categories/sourceinsight' style='font-size: 107.5%'>sourceinsight(1)</a> <a href='/blog/categories/sysctl' style='font-size: 107.5%'>sysctl(1)</a> <a href='/blog/categories/systemd' style='font-size: 107.5%'>systemd(1)</a> <a href='/blog/categories/todo' style='font-size: 107.5%'>todo(1)</a> <a href='/blog/categories/tool' style='font-size: 160.0%'>tool(8)</a> <a href='/blog/categories/ubuntu' style='font-size: 107.5%'>ubuntu(1)</a> <a href='/blog/categories/vim' style='font-size: 107.5%'>vim(1)</a> <a href='/blog/categories/gong-ju' style='font-size: 107.5%'>工具(1)</a> <a href='/blog/categories/shu-tong' style='font-size: 107.5%'>数通(1)</a> <a href='/blog/categories/she-ji-mo-shi' style='font-size: 107.5%'>设计模式(1)</a> </span>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2020 - Iskey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
