
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Iskey's Blog</title>
  <meta name="author" content="Iskey">

  
  <meta name="description" content="OCP全称是Open Computer Project，是Facebook发起并主导的一个硬件开源组织。该组织主要关注数据中心产品的开源及共享，标准化产品的硬件设计，以期打破数据中心产品提供商的硬件壁垒，从而降低成本，提高效率。 目前该组织关注的产品包括，存储设备、服务器主板、服务器机柜、虚拟I/ &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://iskey.github.io/posts/4/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Iskey's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Iskey's Blog</a></h1>
  
    <h2>A free place to write something down.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="iskey.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/23/OCP-open-switch-ONIE/">OCP开源交换机之ONIE杂记</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-23T03:46:31+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>3:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OCP全称是Open Computer Project，是Facebook发起并主导的一个硬件开源组织。该组织主要关注数据中心产品的开源及共享，标准化产品的硬件设计，以期打破数据中心产品提供商的硬件壁垒，从而降低成本，提高效率。</p>

<p>目前该组织关注的产品包括，存储设备、服务器主板、服务器机柜、虚拟I/O、硬件驱动管理、数据中心基础架构设计、三层交换机等。</p>

<p>ONIE软件相当于一个集成众多工具包的微型Linux系统，通过这个微型Linux环境，可以安装和启动符合要求的交换机软件系统。
如此依赖，交换机被分割为两个独立的部分，OCP组织负责指定硬件设计规范，代工厂商，如天弘等根据规范生产硬件。软件厂商适配自己的交换机系统到OCP硬件上，这样组合起来的交换机就是白牌交换机。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/06/svn-snapshot/">Svn源码树快照生成工具</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-06T01:49:12+00:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:49 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>项目的源码管理工具使用的是SVN，由于涉及的项目组众多，源码库功能模块分散在众多小的源码库中，最终的项目源码发布需要从各个源码库中抓取分支，然后版本发布。</p>

<p>这就给版本管理员带来了麻烦，发布版本的时候，需要从各个源码库抓取源码，然后进行编译，调试过程中出现问题，就在需要更新出问题的源码分支，甚至有可能会临时的修改源码中的某一些文件。</p>

<p>开发人员如果想要使用某一个版本的源码，一般把版本管理员发布的源码包下载下来，然后在进行Bug定位和跟踪，由于源码量比较大，所以造成了很大的不方便。</p>

<p>所以编写了下边的源码快照工具，有以下功能：</p>

<ul>
<li>遍历所有的源码库，获取并记录所有的源码库当前版本号</li>
<li>记录当前源码库中，新修改提交的文件版本号。（svn 只更新提交了的个别文件）</li>
<li>记录当前临时修改，但没有提交的代码，并生成patch文件放到patches/目录。</li>
<li>对于无法生成patch的二进制文件，则拷贝到patches/目录。</li>
<li>生成snapshot.sh脚本，这个脚本包含了当前svn源码树的快照信息。</li>
</ul>


<p>在任意的项目SVN源码树，把前边输出的snapshot.sh和patches/目录放到这个源码树的根目录，执行snapshot.就可以恢复到相应的快照状态。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>### exec this scripts in root directory.
</span><span class='line'>### the snapshot of the work copy will be saved to $OUT.
</span><span class='line'>
</span><span class='line'>OUT=$(pwd)/snapshot.sh
</span><span class='line'>PATCH_DIR=$(pwd)/patches
</span><span class='line'>EAT=$(pwd)/eat
</span><span class='line'>patch_idx=0
</span><span class='line'>mime_file_idx=0
</span><span class='line'>
</span><span class='line'>echo "### V3.02.20 svn snapshot scripts ###" &gt;$OUT
</span><span class='line'>echo "PATCH_DIR=\$(pwd)/patches" &gt;&gt;$OUT
</span><span class='line'>
</span><span class='line'>echo -e "\ncheck_svn_tree()
</span><span class='line'>{
</span><span class='line'>f_temp=\$1
</span><span class='line'>f_temp=\${f_temp%/*}
</span><span class='line'>if ! test -d \$f_temp
</span><span class='line'>then
</span><span class='line'>  while( ! test -d  \${f_temp%/*})
</span><span class='line'>  do
</span><span class='line'>      f_last=\$f_temp
</span><span class='line'>      f_temp=\${f_temp%/*}
</span><span class='line'>      if [ \"\$f_last\" = \"\$f_temp\" ]
</span><span class='line'>      then
</span><span class='line'>          break
</span><span class='line'>      fi
</span><span class='line'>  done
</span><span class='line'>  echo \"will update \$f_temp\"
</span><span class='line'>  svn update \$f_temp
</span><span class='line'>fi
</span><span class='line'>}\n" &gt;&gt;$OUT
</span><span class='line'>
</span><span class='line'>#Prepare eat program for svn diff.
</span><span class='line'>touch $EAT
</span><span class='line'>chmod a+x $EAT
</span><span class='line'>
</span><span class='line'>rm $PATCH_DIR -fr
</span><span class='line'>mkdir -p $PATCH_DIR
</span><span class='line'>
</span><span class='line'>#Find svn repositories.
</span><span class='line'>#svn_repos=$(find ./ -name '*.svn' -type d -print)
</span><span class='line'>svn_repos="./ "
</span><span class='line'>svn_repos+=$(svn status | grep ^Perf | cut -d\' -f 2)
</span><span class='line'>for svn_repo in $svn_repos
</span><span class='line'>do
</span><span class='line'>  #svn_dir=${svn_repo%/*}
</span><span class='line'>  svn_dir=$svn_repo
</span><span class='line'>  cd $svn_dir
</span><span class='line'>  #Get svn local copy's revision.
</span><span class='line'>  REV=$(svn info . | sed -n '/Revision:/p' | awk '{print $2}')
</span><span class='line'>  echo "cd $svn_dir"
</span><span class='line'>  echo "cd $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "echo Cleaning: $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st | grep '^?' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st --no-ignore | grep '^I' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "echo Reverting: $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "svn cleanup" &gt;&gt;$OUT
</span><span class='line'>  echo "svn revert . -R" &gt;&gt;$OUT
</span><span class='line'>  echo "svn update . -r $REV" &gt;&gt;$OUT
</span><span class='line'>  echo "svn revert . -R" &gt;&gt;$OUT
</span><span class='line'>  
</span><span class='line'>  #Get svn local copy's changed files.
</span><span class='line'>  M_LIST=$(svn diff -r BASE:COMMITTED --diff-cmd $EAT | sed -n '/Index:/p' | awk '{print $2}')
</span><span class='line'>  for svn_file in $M_LIST
</span><span class='line'>  do
</span><span class='line'>      echo "  Changed File: "$svn_file
</span><span class='line'>      #Get changed file's revision.
</span><span class='line'>      file_rev=$(svn info $svn_file | sed -n '/Last Changed Rev:/p' | awk '{print $4}')
</span><span class='line'>      echo "#----------" &gt;&gt;$OUT
</span><span class='line'>      echo "svn revert $svn_file &gt;/dev/null 2&gt;&1" &gt;&gt;$OUT
</span><span class='line'>      echo "check_svn_tree $svn_file" &gt;&gt;$OUT
</span><span class='line'>      echo "svn update -r $file_rev $svn_file" &gt;&gt;$OUT
</span><span class='line'>      echo "svn revert $svn_file" &gt;&gt;$OUT
</span><span class='line'>  done
</span><span class='line'>  
</span><span class='line'>  #Clean again after revert.
</span><span class='line'>  echo "svn st | grep '^?' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st --no-ignore | grep '^I' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  
</span><span class='line'>  #Get temporary patches
</span><span class='line'>  PATCH_FILES=$(svn diff . --diff-cmd $EAT | sed -n '/Index:/p' | awk '{print $2}')
</span><span class='line'>  if [ ""x != "$PATCH_FILES"x ];then
</span><span class='line'>      let patch_idx+=1
</span><span class='line'>      echo "#==========" &gt;&gt;$OUT
</span><span class='line'>      svn diff . &gt;$PATCH_DIR/$patch_idx.patch
</span><span class='line'>      echo "patch -p0 &lt;\$PATCH_DIR/$patch_idx.patch" &gt;&gt;$OUT
</span><span class='line'>  fi
</span><span class='line'>  
</span><span class='line'>  for mime_file in $PATCH_FILES
</span><span class='line'>  do
</span><span class='line'>      mime_type=$(svn pl $mime_file | sed -n '/svn:mime-type/p')
</span><span class='line'>      if [ ""x != "$mime_type"x ];then
</span><span class='line'>          let mime_file_idx+=1
</span><span class='line'>          cp $mime_file $PATCH_DIR/${mime_file_idx}_${mime_file##*/} -fr
</span><span class='line'>          echo "#==========" &gt;&gt;$OUT
</span><span class='line'>          echo "cp \$PATCH_DIR/${mime_file_idx}_${mime_file##*/} $mime_file -f" &gt;&gt;$OUT
</span><span class='line'>      fi
</span><span class='line'>  done
</span><span class='line'>  
</span><span class='line'>  echo "cd -&gt;/dev/null" &gt;&gt; $OUT
</span><span class='line'>  echo "" &gt;&gt;$OUT
</span><span class='line'>  echo "###############"&gt;&gt; $OUT
</span><span class='line'>  echo "" &gt;&gt;$OUT
</span><span class='line'>  cd - &gt; /dev/null
</span><span class='line'>done</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/13/python-get-current-line-number/">Python获取当前行号</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-13T23:44:00+00:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>对于python，这几天一直有两个问题在困扰我:
- <strong>python中没办法直接取得当前的行号和函数名?</strong>,
这是有人在论坛里提出的问题，底下一群人只是在猜测python为什么不像<strong>file</strong>一样提供<strong>line</strong>和<strong>func</strong>，但是却最终也没有找到解决方案。
- <strong>如果一个函数在不知道自己名字的情况下，怎么才能递归调用自己</strong>。
这是我一个同事问我的，其实也是获取函数名，但是当时也是回答不出来。</p>

<p>但是今晚！所有的问题都有了答案。
一切还要从我用python的logging模块说起，logging中的format中是有如下选项的:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%(name)s            Name of the logger (logging channel)
</span><span class='line'>%(levelno)s         Numeric logging level for the message (DEBUG, INFO,
</span><span class='line'>                    WARNING, ERROR, CRITICAL)
</span><span class='line'>%(levelname)s       Text logging level for the message ("DEBUG", "INFO",
</span><span class='line'>                    "WARNING", "ERROR", "CRITICAL")
</span><span class='line'>%(pathname)s        Full pathname of the source file where the logging
</span><span class='line'>                    call was issued (if available)
</span><span class='line'>%(filename)s        Filename portion of pathname
</span><span class='line'>%(module)s          Module (name portion of filename)
</span><span class='line'>%(lineno)d          Source line number where the logging call was issued
</span><span class='line'>                    (if available)
</span><span class='line'>%(funcName)s        Function name
</span><span class='line'>%(created)f         Time when the LogRecord was created (time.time()
</span><span class='line'>                    return value)
</span><span class='line'>%(asctime)s         Textual time when the LogRecord was created
</span><span class='line'>%(msecs)d           Millisecond portion of the creation time
</span><span class='line'>%(relativeCreated)d Time in milliseconds when the LogRecord was created,
</span><span class='line'>                    relative to the time the logging module was loaded
</span><span class='line'>                    (typically at application startup time)
</span><span class='line'>%(thread)d          Thread ID (if available)
</span><span class='line'>%(threadName)s      Thread name (if available)
</span><span class='line'>%(process)d         Process ID (if available)
</span><span class='line'>%(message)s         The result of record.getMessage(), computed just as
</span><span class='line'>                    the record is emitted</span></code></pre></td></tr></table></div></figure>


<p>也就是说，logging是能够获取到调用者的行号和函数名的，那会不会也可以获取到自己的行号和函数名呢？
我们来看一下源码，主要部分如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def currentframe():
</span><span class='line'>    """Return the frame object for the caller's stack frame."""
</span><span class='line'>    try:
</span><span class='line'>        raise Exception
</span><span class='line'>    except:
</span><span class='line'>        return sys.exc_info()[2].tb_frame.f_back
</span><span class='line'>def findCaller(self):
</span><span class='line'>    """
</span><span class='line'>    Find the stack frame of the caller so that we can note the source
</span><span class='line'>    file name, line number and function name.
</span><span class='line'>    """
</span><span class='line'>    f = currentframe()
</span><span class='line'>    #On some versions of IronPython, currentframe() returns None if
</span><span class='line'>    #IronPython isn't run with -X:Frames.
</span><span class='line'>    if f is not None:
</span><span class='line'>        f = f.f_back
</span><span class='line'>    rv = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    while hasattr(f, "f_code"):
</span><span class='line'>        co = f.f_code
</span><span class='line'>        filename = os.path.normcase(co.co_filename)
</span><span class='line'>        if filename == _srcfile:
</span><span class='line'>            f = f.f_back
</span><span class='line'>            continue
</span><span class='line'>        rv = (co.co_filename, f.f_lineno, co.co_name)
</span><span class='line'>        break
</span><span class='line'>    return rv
</span><span class='line'>def _log(self, level, msg, args, exc_info=None, extra=None):
</span><span class='line'>    """
</span><span class='line'>    Low-level logging routine which creates a LogRecord and then calls
</span><span class='line'>    all the handlers of this logger to handle the record.
</span><span class='line'>    """
</span><span class='line'>    if _srcfile:
</span><span class='line'>        #IronPython doesn't track Python frames, so findCaller throws an
</span><span class='line'>        #exception on some versions of IronPython. We trap it here so that
</span><span class='line'>        #IronPython can use logging.
</span><span class='line'>        try:
</span><span class='line'>            fn, lno, func = self.findCaller()
</span><span class='line'>        except ValueError:
</span><span class='line'>            fn, lno, func = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    else:
</span><span class='line'>        fn, lno, func = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    if exc_info:
</span><span class='line'>        if not isinstance(exc_info, tuple):
</span><span class='line'>            exc_info = sys.exc_info()
</span><span class='line'>    record = self.makeRecord(self.name, level, fn, lno, msg, args, exc_info, func, extra)
</span><span class='line'>    self.handle(record)</span></code></pre></td></tr></table></div></figure>


<p>我简单解释一下，实际上是通过在currentframe函数中抛出一个异常，然后通过向上查找的方式，找到调用的信息。其中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rv = (co.co_filename, f.f_lineno, co.co_name)</span></code></pre></td></tr></table></div></figure>


<p>的三个值分别为文件名，行号，函数名。(可以去<a href="http://docs.python.org/library/sys.html">http://docs.python.org/library/sys.html</a> 来看一下代码中几个系统函数的说明)
OK，如果已经看懂了源码，那获取当前位置的行号和函数名相信也非常清楚了，代码如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/python
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'>'''
</span><span class='line'>#=============================================================================
</span><span class='line'>#  Author:          dantezhu - http://www.vimer.cn
</span><span class='line'>#  Email:           zny2008@gmail.com
</span><span class='line'>#  FileName:        xf.py
</span><span class='line'>#  Description:     获取当前位置的行号和函数名
</span><span class='line'>#  Version:         1.0
</span><span class='line'>#  LastChange:      2010-12-17 01:19:19
</span><span class='line'>#  History:         
</span><span class='line'>#=============================================================================
</span><span class='line'>'''
</span><span class='line'>import sys
</span><span class='line'>def get_cur_info():
</span><span class='line'>    """Return the frame object for the caller's stack frame."""
</span><span class='line'>    try:
</span><span class='line'>        raise Exception
</span><span class='line'>    except:
</span><span class='line'>        f = sys.exc_info()[2].tb_frame.f_back
</span><span class='line'>    return (f.f_code.co_name, f.f_lineno)
</span><span class='line'>
</span><span class='line'>def callfunc():
</span><span class='line'>    print get_cur_info()
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    callfunc()</span></code></pre></td></tr></table></div></figure>


<p>输出结果是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>('callfunc', 24)</span></code></pre></td></tr></table></div></figure>


<p>后来发现，其实也可以有更简单的方法，如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import sys
</span><span class='line'>def get_cur_info():
</span><span class='line'>    print sys._getframe().f_code.co_name
</span><span class='line'>    print sys._getframe().f_back.f_code.co_name
</span><span class='line'>get_cur_info()</span></code></pre></td></tr></table></div></figure>


<p>调用结果是:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>get_cur_info
</span><span class='line'>&lt;module&gt;</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.vimer.cn/2010/12/%E5%9C%A8python%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E4%BD%8D%E7%BD%AE%E6%89%80%E5%9C%A8%E7%9A%84%E8%A1%8C%E5%8F%B7%E5%92%8C%E5%87%BD%E6%95%B0%E5%90%8D.html">转载地址</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/18/linux-self-extract/">Linux自解压文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T08:44:00+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>经常从网络上下载.run格式的安装包，直接运行就能够执行程序安装了，很简单方便，一直也没有仔细研究过，前段时间学习开源交换机ONIE的NOS安装镜像，需要自己制作一个NOS的安装镜像，于是就学习了一下。</p>

<h3>网上最常用的一种方式是通过tail命令+tar命令来实现：</h3>

<ul>
<li>首先把想要安装的文件通过tar命令进行打包，当然也可用zip、gunzip等命令</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ls
</span><span class='line'>target
</span><span class='line'>
</span><span class='line'>$tar -cvf target.tar target/
</span><span class='line'>target/
</span><span class='line'>target/t.sh
</span><span class='line'>target/System.map
</span><span class='line'>
</span><span class='line'>$ls
</span><span class='line'>target.tar</span></code></pre></td></tr></table></div></figure>


<ul>
<li>新建自解压脚本，本例取名self_extract.sh,可以自己修改这个脚本，添加自己的安装过程。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat self_extract.sh                                                                      
</span><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>lines=%%SELF_EXTRACT_LINES%%
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>tail $lines $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>#添加你自己的安装过程
</span><span class='line'>
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改这个self_extract.sh文件中的<code>%%SELF_EXTRACT_LINES%%</code>变量。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$LINE=$(wc -l self_extract.sh | awk -F" " '{print $1+1}')| echo $LINE | sed -i -e "s/%%SELF_EXTRACT_LINES%%/$LINE/" self_extract.sh</span></code></pre></td></tr></table></div></figure>


<p>修改后的脚本文件为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>lines=10
</span><span class='line'>
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>tail -n +$lines $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>exit 0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>把第一步生成的target.tar文件追加到slef_extract.sh脚本。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat target.tar &gt;&gt; self_extract.sh</span></code></pre></td></tr></table></div></figure>


<ul>
<li>执行最终生成的self_extract.sh后，目录下就会最终生成target目录了。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./self_extract.sh 
</span><span class='line'>$ls
</span><span class='line'>self_extract.sh  target</span></code></pre></td></tr></table></div></figure>


<h3>ONIE的做法</h3>

<ul>
<li>ONIE的做法更加简洁：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat self_extract.sh 
</span><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>sed -e '1,/^__exit_marker__$/d' $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>exit 0
</span><span class='line'>
</span><span class='line'>__exit_marker__</span></code></pre></td></tr></table></div></figure>


<ul>
<li>追加target.tar到self_extrac.sh文件。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat target.tar &gt;&gt; self_extract.sh</span></code></pre></td></tr></table></div></figure>


<ul>
<li>执行self_extract.sh就可以了</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./self_extract.sh 
</span><span class='line'>$ls
</span><span class='line'>self_extract.sh  target</span></code></pre></td></tr></table></div></figure>


<h3>ONIE格式的安装包加入校验</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sha1=$(sed -e '1,/^__exit_marker__$/d' "$0" | sha1sum | awk '{ print $1 }')
</span><span class='line'>
</span><span class='line'>payload_sha1=%%IMAGE_SHA1%%
</span><span class='line'>
</span><span class='line'>if [ "$sha1" != "$payload_sha1" ] ; then
</span><span class='line'>    echo
</span><span class='line'>    echo "ERROR: Unable to verify archive checksum"
</span><span class='line'>    echo "Expected: $payload_sha1"
</span><span class='line'>    echo "Found   : $sha1"
</span><span class='line'>    exit 1
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>需要在把target.tar文件追加到self_extract.sh之前，先替换<code>%%IMAGS_SHA1%%</code>变量。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$SHASUM=$(sha1sum target.tar | awk '{print $1}') | sed -i -e 's/%%IMAGE_SHA1%%/$SHASUM' self_extrac.sh</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/01/23/pattern-single/">设计模式之单例模式</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-01-23T03:46:31+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2015</span></span> <span class='time'>3:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>单例模式又称单件模式，是指整个程序的生命周期内，任一时刻，都只允许一个实例存在。</p>

<p>单例模式一般包含两层意思：</p>

<blockquote><ul>
<li>全局访问</li>
<li>全程唯一</li>
</ul>
</blockquote>

<p>一般，我们很容易把单例模式和全局变量混淆，觉得使用全局变量就是单例模式。
仔细分析，我们就会认识到，全局变量只实现了单例模式的<strong>全局访问</strong>特性，但是并不能保证<strong>全局唯一</strong>特性。</p>

<p>况且，全局变量在许多的代码规范中，都是不建议使用的。</p>

<p>在C语言中，单例模式一般设计如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>struct Singleton{};
</span><span class='line'>
</span><span class='line'>int get_instance()
</span><span class='line'>{
</span><span class='line'>    static Singleton *global_instance= NULL;
</span><span class='line'>    
</span><span class='line'>    if(NULL== global_instance){
</span><span class='line'>        global_instance= malloc(sizeof(Singleton));
</span><span class='line'>    }
</span><span class='line'>    
</span><span class='line'>    return global_instance;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>但是放到多线程环境下，如上的实例就不能保证，在整个生命周期都是全局唯一了，多个线程有可能对同时进入初始化过程，所以需要加上多线程互斥访问机制，所以就可以写成如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>pthread_mutex_t singleton_lock=PTHREAD_MUTEX_INITIALIZER;
</span><span class='line'>struct Singleton{};
</span><span class='line'>
</span><span class='line'>int get_instance()
</span><span class='line'>{
</span><span class='line'>    static struct Singleton *global_instance= NULL;
</span><span class='line'>    
</span><span class='line'>    pthread_mutex_lock(&singleton_lock);
</span><span class='line'>    if(NULL== global_instance){
</span><span class='line'>        global_instance= malloc(sizeof(Singleton));
</span><span class='line'>        global_instance-&gt;lock= PTHREAD_MUTEX_INITIALIZER;
</span><span class='line'>    }
</span><span class='line'>    pthread_mutex_unlock(&singleton_lock);
</span><span class='line'>    
</span><span class='line'>    return global_instance;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>现在不会出现多个线程同时初始化单件实例的情况了，但是随之而来的就是每次获取全局实例，都要执行一遍加锁、解锁的过程。
这时"饿汉写法"的弊端，如果单例的访问频次比较高，就需要另外新建一个执行初始化的函数，也就是所谓的“懒汉模式”。</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/3">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/07/07/simpe-example-of-kubernetes/">Simpe_example_of_kubernetes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/helloworld-of-systemd/">Helloworld_of_systemd</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/use-lvm-to-expend-root-partition/">Use Lvm to Expend Root Partition</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/07/07/install-octopress-on-windows/">Install Octopress on Windows</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/30/minikube-install/">Minikube Install</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/iptables/'>iptables (1)</a></li><li><a href='/blog/categories/kernel/'>kernel (5)</a></li><li><a href='/blog/categories/linuxc/'>linuxc (1)</a></li><li><a href='/blog/categories/linuxbian-cheng/'>linux编程 (1)</a></li><li><a href='/blog/categories/lvm/'>lvm (1)</a></li><li><a href='/blog/categories/makefile/'>makefile (2)</a></li><li><a href='/blog/categories/netfilter/'>netfilter (1)</a></li><li><a href='/blog/categories/ocp/'>ocp (2)</a></li><li><a href='/blog/categories/octopress/'>octopress (1)</a></li><li><a href='/blog/categories/python/'>python (1)</a></li><li><a href='/blog/categories/regax/'>regax (1)</a></li><li><a href='/blog/categories/shell/'>shell (3)</a></li><li><a href='/blog/categories/sourceinsight/'>sourceinsight (1)</a></li><li><a href='/blog/categories/sysctl/'>sysctl (1)</a></li><li><a href='/blog/categories/systemd/'>systemd (1)</a></li><li><a href='/blog/categories/todo/'>todo (1)</a></li><li><a href='/blog/categories/ubuntu/'>ubuntu (1)</a></li><li><a href='/blog/categories/vim/'>vim (1)</a></li><li><a href='/blog/categories/chuan-kou/'>串口 (1)</a></li><li><a href='/blog/categories/gong-ju/'>工具 (2)</a></li><li><a href='/blog/categories/wang-luo/'>网络 (3)</a></li><li><a href='/blog/categories/she-ji-mo-shi/'>设计模式 (1)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/iptables' style='font-size: 112.0%'>iptables(1)</a> <a href='/blog/categories/kernel' style='font-size: 160.0%'>kernel(5)</a> <a href='/blog/categories/linuxc' style='font-size: 112.0%'>linuxc(1)</a> <a href='/blog/categories/linuxbian-cheng' style='font-size: 112.0%'>linux编程(1)</a> <a href='/blog/categories/lvm' style='font-size: 112.0%'>lvm(1)</a> <a href='/blog/categories/makefile' style='font-size: 124.0%'>makefile(2)</a> <a href='/blog/categories/netfilter' style='font-size: 112.0%'>netfilter(1)</a> <a href='/blog/categories/ocp' style='font-size: 124.0%'>ocp(2)</a> <a href='/blog/categories/octopress' style='font-size: 112.0%'>octopress(1)</a> <a href='/blog/categories/python' style='font-size: 112.0%'>python(1)</a> <a href='/blog/categories/regax' style='font-size: 112.0%'>regax(1)</a> <a href='/blog/categories/shell' style='font-size: 136.0%'>shell(3)</a> <a href='/blog/categories/sourceinsight' style='font-size: 112.0%'>sourceinsight(1)</a> <a href='/blog/categories/sysctl' style='font-size: 112.0%'>sysctl(1)</a> <a href='/blog/categories/systemd' style='font-size: 112.0%'>systemd(1)</a> <a href='/blog/categories/todo' style='font-size: 112.0%'>todo(1)</a> <a href='/blog/categories/ubuntu' style='font-size: 112.0%'>ubuntu(1)</a> <a href='/blog/categories/vim' style='font-size: 112.0%'>vim(1)</a> <a href='/blog/categories/chuan-kou' style='font-size: 112.0%'>串口(1)</a> <a href='/blog/categories/gong-ju' style='font-size: 124.0%'>工具(2)</a> <a href='/blog/categories/wang-luo' style='font-size: 136.0%'>网络(3)</a> <a href='/blog/categories/she-ji-mo-shi' style='font-size: 112.0%'>设计模式(1)</a> </span>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Iskey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
