
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Iskey's Blog</title>
  <meta name="author" content="Iskey">

  
  <meta name="description" content="最近需要使用netlink来完成内核层和用户层的通讯，搜集了一个网上的例子，暂时摘抄在此，并计划再接下来再补充一些东西： ToDoList: [x] 重写netlink内核实现，把处理函数放在内核线程里。
[ ] 使用net_namespace机制下的general netlink接口写一个列子 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://iskey.github.io/posts/3/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Iskey's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="/javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Iskey's Blog</a></h1>
  
    <h2>A free place to write something down.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="iskey.github.io">
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/07/linux-netlink-conn/">Linux Netlink通讯</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-07T13:12:00+00:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>7</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>1:12 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>最近需要使用netlink来完成内核层和用户层的通讯，搜集了一个网上的例子，暂时摘抄在此，并计划再接下来再补充一些东西：</p>

<p><strong>ToDoList:</strong></p>

<blockquote><ul>
<li>[x] 重写netlink内核实现，把处理函数放在内核线程里。</li>
<li>[ ] 使用net_namespace机制下的general netlink接口写一个列子。</li>
</ul>
</blockquote>

<h1>摘录版本</h1>

<hr />

<h2>内核代码</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;linux/init.h&gt;
</span><span class='line'>#include &lt;linux/module.h&gt;
</span><span class='line'>#include &lt;linux/timer.h&gt;
</span><span class='line'>#include &lt;linux/time.h&gt;
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>#include &lt;net/sock.h&gt;
</span><span class='line'>#include &lt;net/netlink.h&gt;
</span><span class='line'>
</span><span class='line'>#define NETLINK_TEST 25
</span><span class='line'>#define MAX_MSGSIZE 1024
</span><span class='line'>int stringlength(char *s);
</span><span class='line'>void sendnlmsg(int pid, char * message);
</span><span class='line'>int err;
</span><span class='line'>struct sock *nl_sk = NULL;
</span><span class='line'>
</span><span class='line'>void sendnlmsg(int pid, char *message)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *skb_1;
</span><span class='line'>    struct nlmsghdr *nlh;
</span><span class='line'>    int len = NLMSG_SPACE(MAX_MSGSIZE);
</span><span class='line'>    int slen = 0;
</span><span class='line'>    if(!message || !nl_sk)
</span><span class='line'>    {
</span><span class='line'>        return ;
</span><span class='line'>    }
</span><span class='line'>    skb_1 = alloc_skb(len,GFP_KERNEL);
</span><span class='line'>    if(!skb_1)
</span><span class='line'>    {
</span><span class='line'>        printk(KERN_ERR "my_net_link:alloc_skb_1 error\n");
</span><span class='line'>    }
</span><span class='line'>    slen = stringlength(message);
</span><span class='line'>    nlh = nlmsg_put(skb_1,0,0,0,MAX_MSGSIZE,0);
</span><span class='line'>
</span><span class='line'>    NETLINK_CB(skb_1).pid = 0;
</span><span class='line'>    NETLINK_CB(skb_1).dst_group = 0;
</span><span class='line'>
</span><span class='line'>    message[slen]= '\0';
</span><span class='line'>    memcpy(NLMSG_DATA(nlh),message,slen+1);
</span><span class='line'>    printk("my_net_link:send message '%s'.\n",(char *)NLMSG_DATA(nlh));
</span><span class='line'>
</span><span class='line'>    netlink_unicast(nl_sk,skb_1,pid,MSG_DONTWAIT);
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int stringlength(char *s)
</span><span class='line'>{
</span><span class='line'>    int slen = 0;
</span><span class='line'>
</span><span class='line'>    for(; *s; s++){
</span><span class='line'>        slen++;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return slen;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void nl_data_ready(struct sk_buff *__skb)
</span><span class='line'> {
</span><span class='line'>    struct sk_buff *skb;
</span><span class='line'>    struct nlmsghdr *nlh;
</span><span class='line'>    char str[100];
</span><span class='line'>    struct completion cmpl;
</span><span class='line'>    int i=2;
</span><span class='line'>    skb = skb_get(__skb);
</span><span class='line'>    if(skb-&gt;len &gt;= NLMSG_SPACE(0))
</span><span class='line'>    {
</span><span class='line'>        nlh = nlmsg_hdr(skb);
</span><span class='line'>
</span><span class='line'>        memcpy(str, NLMSG_DATA(nlh), sizeof(str));
</span><span class='line'>        printk("Message received from pid-%d:%s\n",nlh-&gt;nlmsg_pid, str) ;
</span><span class='line'>        while(i--)
</span><span class='line'>        {
</span><span class='line'>            init_completion(&cmpl);
</span><span class='line'>            wait_for_completion_timeout(&cmpl,3 * HZ);
</span><span class='line'>            sendnlmsg(nlh-&gt;nlmsg_pid, "I am from kernel!");
</span><span class='line'>        }
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'>// Initialize netlink
</span><span class='line'>int netlink_init(void)
</span><span class='line'>{
</span><span class='line'>    nl_sk = netlink_kernel_create(&init_net, NETLINK_TEST, 1,
</span><span class='line'>                                 nl_data_ready, NULL, THIS_MODULE);
</span><span class='line'>
</span><span class='line'>    if(!nl_sk){
</span><span class='line'>        printk(KERN_ERR "my_net_link: create netlink socket error.\n");
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    printk("my_net_link_3: create netlink socket ok.\n");
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void netlink_exit(void)
</span><span class='line'>{
</span><span class='line'>    if(nl_sk != NULL){
</span><span class='line'>        sock_release(nl_sk-&gt;sk_socket);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    printk("my_net_link: self module exited\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module_init(netlink_init);
</span><span class='line'>module_exit(netlink_exit);
</span><span class='line'>
</span><span class='line'>MODULE_AUTHOR("frankzfz");
</span><span class='line'>MODULE_LICENSE("GPL");</span></code></pre></td></tr></table></div></figure>


<h2>　用户空间代码</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/stat.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;asm/types.h&gt;
</span><span class='line'>#include &lt;linux/netlink.h&gt;
</span><span class='line'>#include &lt;linux/socket.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>
</span><span class='line'>#define NETLINK_TEST 25
</span><span class='line'>#define MAX_PAYLOAD 1024 // maximum payload size
</span><span class='line'>
</span><span class='line'>int main(int argc, char* argv[])
</span><span class='line'>{
</span><span class='line'>    int state;
</span><span class='line'>    struct sockaddr_nl src_addr, dest_addr;
</span><span class='line'>    struct nlmsghdr *nlh = NULL;
</span><span class='line'>    struct iovec iov;
</span><span class='line'>    struct msghdr msg;
</span><span class='line'>    int sock_fd, retval;
</span><span class='line'>    int state_smg = 0;
</span><span class='line'>    
</span><span class='line'>    // Create a socket
</span><span class='line'>    sock_fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_TEST);
</span><span class='line'>    if(sock_fd == -1){
</span><span class='line'>        printf("error getting socket: %s", strerror(errno));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // To prepare binding
</span><span class='line'>    memset(&msg,0,sizeof(msg));
</span><span class='line'>    memset(&src_addr, 0, sizeof(src_addr));
</span><span class='line'>    src_addr.nl_family = AF_NETLINK;
</span><span class='line'>    src_addr.nl_pid = getpid(); // self pid
</span><span class='line'>    src_addr.nl_groups = 0; // multi cast
</span><span class='line'>
</span><span class='line'>    retval = bind(sock_fd, (struct sockaddr*)&src_addr, sizeof(src_addr));
</span><span class='line'>    if(retval &lt; 0){
</span><span class='line'>        printf("bind failed: %s", strerror(errno));
</span><span class='line'>        close(sock_fd);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // To prepare recvmsg
</span><span class='line'>    nlh = (struct nlmsghdr *)malloc(NLMSG_SPACE(MAX_PAYLOAD));
</span><span class='line'>    if(!nlh){
</span><span class='line'>        printf("malloc nlmsghdr error!\n");
</span><span class='line'>        close(sock_fd);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    memset(&dest_addr,0,sizeof(dest_addr));
</span><span class='line'>    dest_addr.nl_family = AF_NETLINK;
</span><span class='line'>    dest_addr.nl_pid = 0;
</span><span class='line'>    dest_addr.nl_groups = 0;
</span><span class='line'>
</span><span class='line'>    nlh-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);
</span><span class='line'>    nlh-&gt;nlmsg_pid = getpid();
</span><span class='line'>    nlh-&gt;nlmsg_flags = 0;
</span><span class='line'>    strcpy(NLMSG_DATA(nlh),"Hello you iskey!");
</span><span class='line'>
</span><span class='line'>    iov.iov_base = (void *)nlh;
</span><span class='line'>    iov.iov_len = NLMSG_SPACE(MAX_PAYLOAD);
</span><span class='line'>//    iov.iov_len = nlh-&gt;nlmsg_len;
</span><span class='line'>
</span><span class='line'>    memset(&msg, 0, sizeof(msg));
</span><span class='line'>    msg.msg_name = (void *)&dest_addr;
</span><span class='line'>    msg.msg_namelen = sizeof(dest_addr);
</span><span class='line'>    msg.msg_iov = &iov;
</span><span class='line'>    msg.msg_iovlen = 1;
</span><span class='line'>
</span><span class='line'>    state_smg = sendmsg(sock_fd,&msg,0);
</span><span class='line'>    if(state_smg == -1)
</span><span class='line'>    {
</span><span class='line'>        printf("get error sendmsg = %s\n",strerror(errno));
</span><span class='line'>    }
</span><span class='line'>    printf("send netlink message ok.\n");
</span><span class='line'>
</span><span class='line'>    memset(nlh,0,NLMSG_SPACE(MAX_PAYLOAD));   
</span><span class='line'>    // Read message from kernel
</span><span class='line'>    while(1){
</span><span class='line'>        printf("In while recvmsg\n");
</span><span class='line'>        state = recvmsg(sock_fd, &msg, 0);
</span><span class='line'>        if(state&lt;0)
</span><span class='line'>        {
</span><span class='line'>            printf("state&lt;1");
</span><span class='line'>        }
</span><span class='line'>        printf("Received message: %s\n",(char *) NLMSG_DATA(nlh));
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    close(sock_fd);
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h1>内核线程版本</h1>

<hr />

<h2>内核代码</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;linux/init.h&gt;
</span><span class='line'>#include &lt;linux/module.h&gt;
</span><span class='line'>#include &lt;linux/timer.h&gt;
</span><span class='line'>#include &lt;linux/time.h&gt;
</span><span class='line'>#include &lt;linux/types.h&gt;
</span><span class='line'>#include &lt;net/sock.h&gt;
</span><span class='line'>#include &lt;net/netlink.h&gt;
</span><span class='line'>#include "linux/list.h"
</span><span class='line'>#include &lt;linux/kthread.h&gt;
</span><span class='line'>
</span><span class='line'>#define NETLINK_TEST 25
</span><span class='line'>#define MAX_MSGSIZE 1024
</span><span class='line'>int stringlength(char *s);
</span><span class='line'>void sendnlmsg(int pid, char * message);
</span><span class='line'>int err;
</span><span class='line'>struct sock *nl_sk = NULL;
</span><span class='line'>
</span><span class='line'>struct _my_user_client_{
</span><span class='line'>    int pid;
</span><span class='line'>    unsigned char *msg;
</span><span class='line'>    struct list_head list; 
</span><span class='line'>};
</span><span class='line'>
</span><span class='line'>//struct list_head client_head;
</span><span class='line'>LIST_HEAD(client_head);
</span><span class='line'>spinlock_t g_cli_list_lock= SPIN_LOCK_UNLOCKED;
</span><span class='line'>struct task_struct *g_thread[10];
</span><span class='line'>
</span><span class='line'>int client_thread(void *data)
</span><span class='line'>{
</span><span class='line'>    struct list_head *plist, *list_n;
</span><span class='line'>    struct _my_user_client_ *my_client;
</span><span class='line'>    struct completion cmpl;
</span><span class='line'>    
</span><span class='line'>    init_completion(&cmpl);
</span><span class='line'>    daemonize("iskey_cli");
</span><span class='line'>
</span><span class='line'>    while(!kthread_should_stop())
</span><span class='line'>    //while(1)
</span><span class='line'>    {        
</span><span class='line'>        spin_lock(&g_cli_list_lock);
</span><span class='line'>        list_for_each_safe(plist, list_n, &client_head){
</span><span class='line'>            my_client= (struct _my_user_client_ *)list_entry(plist, struct _my_user_client_, list);
</span><span class='line'>            printk(KERN_ERR "kernel received msg:%s pid:%d.\n", my_client-&gt;msg, my_client-&gt;pid);
</span><span class='line'>            sendnlmsg(my_client-&gt;pid, "I am from kernel!");
</span><span class='line'>            list_del(plist);
</span><span class='line'>            kfree(my_client);
</span><span class='line'>        }
</span><span class='line'>        spin_unlock(&g_cli_list_lock);
</span><span class='line'>        schedule_timeout_interruptible(msecs_to_jiffies(1));
</span><span class='line'>        wait_for_completion_timeout(&cmpl,3 * HZ);
</span><span class='line'>    }
</span><span class='line'>    printk(KERN_ERR "### thread end.\n");
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void sendnlmsg(int pid, char *message)
</span><span class='line'>{
</span><span class='line'>    struct sk_buff *skb_1;
</span><span class='line'>    struct nlmsghdr *nlh;
</span><span class='line'>    int len = NLMSG_SPACE(MAX_MSGSIZE);
</span><span class='line'>    int slen = 0;
</span><span class='line'>    if(!message || !nl_sk)
</span><span class='line'>    {
</span><span class='line'>        return ;
</span><span class='line'>    }
</span><span class='line'>    skb_1 = alloc_skb(len,GFP_KERNEL);
</span><span class='line'>    if(!skb_1)
</span><span class='line'>    {
</span><span class='line'>        printk(KERN_ERR "my_net_link:alloc_skb_1 error\n");
</span><span class='line'>    }
</span><span class='line'>    slen = stringlength(message);
</span><span class='line'>    nlh = nlmsg_put(skb_1,0,0,0,MAX_MSGSIZE,0);
</span><span class='line'>
</span><span class='line'>    NETLINK_CB(skb_1).pid = 0;
</span><span class='line'>    NETLINK_CB(skb_1).dst_group = 0;
</span><span class='line'>
</span><span class='line'>    message[slen]= '\0';
</span><span class='line'>    memcpy(NLMSG_DATA(nlh),message,slen+1);
</span><span class='line'>    printk("my_net_link:send message '%s' pid:%d.\n",(char *)NLMSG_DATA(nlh), pid);
</span><span class='line'>
</span><span class='line'>    netlink_unicast(nl_sk,skb_1,pid,MSG_DONTWAIT);
</span><span class='line'>
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int stringlength(char *s)
</span><span class='line'>{
</span><span class='line'>    int slen = 0;
</span><span class='line'>
</span><span class='line'>    for(; *s; s++){
</span><span class='line'>        slen++;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    return slen;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>void nl_data_ready(struct sk_buff *__skb)
</span><span class='line'> {
</span><span class='line'>    struct sk_buff *skb;
</span><span class='line'>    struct nlmsghdr *nlh;
</span><span class='line'>    char str[100];
</span><span class='line'>    struct completion cmpl;
</span><span class='line'>    int i=2;
</span><span class='line'>    skb = skb_get(__skb);
</span><span class='line'>    if(skb-&gt;len &gt;= NLMSG_SPACE(0))
</span><span class='line'>    {
</span><span class='line'>        nlh = nlmsg_hdr(skb);
</span><span class='line'>
</span><span class='line'>        memcpy(str, NLMSG_DATA(nlh), sizeof(str));
</span><span class='line'>
</span><span class='line'>        struct _my_user_client_ *client= kmalloc(sizeof(struct _my_user_client_), GFP_KERNEL);
</span><span class='line'>        unsigned char *t_data= kmalloc(sizeof(str),GFP_KERNEL);
</span><span class='line'>        memcpy(t_data, str, sizeof(str));
</span><span class='line'>        client-&gt;msg= t_data;
</span><span class='line'>        client-&gt;pid= nlh-&gt;nlmsg_pid;
</span><span class='line'>        spin_lock(&g_cli_list_lock);
</span><span class='line'>        list_add(&(client-&gt;list),&client_head);
</span><span class='line'>        spin_unlock(&g_cli_list_lock);
</span><span class='line'>        
</span><span class='line'>        printk("Message received from pid-%d:%s\n",nlh-&gt;nlmsg_pid, str) ;
</span><span class='line'>//        while(i--)
</span><span class='line'>//        {
</span><span class='line'>//            init_completion(&cmpl);
</span><span class='line'>//            wait_for_completion_timeout(&cmpl,3 * HZ);
</span><span class='line'>//            sendnlmsg(nlh-&gt;nlmsg_pid, "I am from kernel!");
</span><span class='line'>//        }
</span><span class='line'>        kfree_skb(skb);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'>// Initialize netlink
</span><span class='line'>int netlink_init(void)
</span><span class='line'>{
</span><span class='line'>    nl_sk = netlink_kernel_create(&init_net, NETLINK_TEST, 1,
</span><span class='line'>                                 nl_data_ready, NULL, THIS_MODULE);
</span><span class='line'>
</span><span class='line'>    if(!nl_sk){
</span><span class='line'>        printk(KERN_ERR "my_net_link: create netlink socket error.\n");
</span><span class='line'>        return 1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    int cpu=0;
</span><span class='line'>    
</span><span class='line'>//    for_each_present_cpu(cpu){
</span><span class='line'>        printk(KERN_ERR "cpu id is %d.\n", cpu);
</span><span class='line'>        g_thread[cpu]= kthread_create(client_thread, &cpu, "netlink_thread%d", cpu);
</span><span class='line'>        if(IS_ERR(g_thread[cpu])){
</span><span class='line'>            printk(KERN_ERR "client_thread start error.\n");
</span><span class='line'>            return 2;
</span><span class='line'>        }
</span><span class='line'>
</span><span class='line'>        printk(KERN_ERR "netlink_thread :%s\n", g_thread[0]-&gt;comm);
</span><span class='line'>        
</span><span class='line'>        wake_up_process(g_thread[cpu]);
</span><span class='line'>//    }
</span><span class='line'>    
</span><span class='line'>    printk("my_net_link_3: create netlink socket ok.\n");
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>static void netlink_exit(void)
</span><span class='line'>{
</span><span class='line'>    if(nl_sk != NULL){
</span><span class='line'>        sock_release(nl_sk-&gt;sk_socket);
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    int cpu= 0;
</span><span class='line'>//    for_each_present_cpu(cpu){
</span><span class='line'>        kthread_stop(g_thread[cpu]);
</span><span class='line'>//    }
</span><span class='line'>    
</span><span class='line'>    printk("my_net_link: self module exited\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>module_init(netlink_init);
</span><span class='line'>module_exit(netlink_exit);
</span><span class='line'>
</span><span class='line'>MODULE_AUTHOR("frankzfz");
</span><span class='line'>MODULE_LICENSE("GPL");</span></code></pre></td></tr></table></div></figure>


<h2>　用户空间代码</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;sys/stat.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;sys/socket.h&gt;
</span><span class='line'>#include &lt;sys/types.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;asm/types.h&gt;
</span><span class='line'>#include &lt;linux/netlink.h&gt;
</span><span class='line'>#include &lt;linux/socket.h&gt;
</span><span class='line'>#include &lt;errno.h&gt;
</span><span class='line'>
</span><span class='line'>#define NETLINK_TEST 25
</span><span class='line'>#define MAX_PAYLOAD 1024 // maximum payload size
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>int main(int argc, char* argv[])
</span><span class='line'>{
</span><span class='line'>    int state;
</span><span class='line'>    struct sockaddr_nl src_addr, dest_addr;
</span><span class='line'>    struct nlmsghdr *nlh = NULL;
</span><span class='line'>    struct iovec iov;
</span><span class='line'>    struct msghdr msg;
</span><span class='line'>    int sock_fd, retval;
</span><span class='line'>    int state_smg = 0;
</span><span class='line'>    
</span><span class='line'>    // Create a socket
</span><span class='line'>    sock_fd = socket(AF_NETLINK, SOCK_RAW, NETLINK_TEST);
</span><span class='line'>    if(sock_fd == -1){
</span><span class='line'>        printf("error getting socket: %s", strerror(errno));
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // To prepare binding
</span><span class='line'>    memset(&msg,0,sizeof(msg));
</span><span class='line'>    memset(&src_addr, 0, sizeof(src_addr));
</span><span class='line'>    src_addr.nl_family = AF_NETLINK;
</span><span class='line'>    src_addr.nl_pid = getpid(); // self pid
</span><span class='line'>    src_addr.nl_groups = 0; // multi cast
</span><span class='line'>
</span><span class='line'>    retval = bind(sock_fd, (struct sockaddr*)&src_addr, sizeof(src_addr));
</span><span class='line'>    if(retval &lt; 0){
</span><span class='line'>        printf("bind failed: %s", strerror(errno));
</span><span class='line'>        close(sock_fd);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    // To prepare recvmsg
</span><span class='line'>    nlh = (struct nlmsghdr *)malloc(NLMSG_SPACE(MAX_PAYLOAD));
</span><span class='line'>    if(!nlh){
</span><span class='line'>        printf("malloc nlmsghdr error!\n");
</span><span class='line'>        close(sock_fd);
</span><span class='line'>        return -1;
</span><span class='line'>    }
</span><span class='line'>
</span><span class='line'>    memset(&dest_addr,0,sizeof(dest_addr));
</span><span class='line'>    dest_addr.nl_family = AF_NETLINK;
</span><span class='line'>    dest_addr.nl_pid = 0;
</span><span class='line'>    dest_addr.nl_groups = 0;
</span><span class='line'>
</span><span class='line'>    nlh-&gt;nlmsg_len = NLMSG_SPACE(MAX_PAYLOAD);
</span><span class='line'>    nlh-&gt;nlmsg_pid = getpid();
</span><span class='line'>    nlh-&gt;nlmsg_flags = 0;
</span><span class='line'>    strcpy(NLMSG_DATA(nlh),"Hello you iskey!");
</span><span class='line'>
</span><span class='line'>    iov.iov_base = (void *)nlh;
</span><span class='line'>    iov.iov_len = NLMSG_SPACE(MAX_PAYLOAD);
</span><span class='line'>//    iov.iov_len = nlh-&gt;nlmsg_len;
</span><span class='line'>
</span><span class='line'>    memset(&msg, 0, sizeof(msg));
</span><span class='line'>    msg.msg_name = (void *)&dest_addr;
</span><span class='line'>    msg.msg_namelen = sizeof(dest_addr);
</span><span class='line'>    msg.msg_iov = &iov;
</span><span class='line'>    msg.msg_iovlen = 1;
</span><span class='line'>
</span><span class='line'>    state_smg = sendmsg(sock_fd,&msg,0);
</span><span class='line'>    if(state_smg == -1)
</span><span class='line'>    {
</span><span class='line'>        printf("[user] get error sendmsg = %s\n",strerror(errno));
</span><span class='line'>    }
</span><span class='line'>    printf("[user] send netlink message ok.\n");
</span><span class='line'>
</span><span class='line'>    memset(nlh,0,NLMSG_SPACE(MAX_PAYLOAD));   
</span><span class='line'>    // Read message from kernel
</span><span class='line'>    //while(1){
</span><span class='line'>        printf("[user] receiving netlink msg...\n");
</span><span class='line'>        state = recvmsg(sock_fd, &msg, 0);
</span><span class='line'>        if(state&lt;0)
</span><span class='line'>        {
</span><span class='line'>            printf("[user] state&lt;1");
</span><span class='line'>        }
</span><span class='line'>        printf("[user] Received message: %s\n",(char *) NLMSG_DATA(nlh));
</span><span class='line'>    //}
</span><span class='line'>
</span><span class='line'>    close(sock_fd);
</span><span class='line'>
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/06/linux-shell-IO-redirect/">Linux Shell I/O重定向</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-04-06T15:48:00+00:00'><span class='date'><span class='date-month'>Apr</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>3:48 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>在命令行中，经常会用到shell命令的重定向操作，最常用的做法是重定向到一个文件：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$ls</span> <span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">txt</span>
</span></code></pre></td></tr></table></div></figure>


<p>把当前目录的文件列表重定向到t.txt文件，这里的<strong>></strong>符号的意思就是把<code>ls</code>命令的标准输出重定向到t.txt文件。
熟悉linux的同学都知道，linux 有三个标准句柄，</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="mi">0</span><span class="o">:</span> <span class="n">stdin</span>
</span><span class='line'><span class="mi">1</span><span class="o">:</span> <span class="n">stdout</span>
</span><span class='line'><span class="mi">2</span><span class="o">:</span> <span class="n">stderr</span>
</span></code></pre></td></tr></table></div></figure>


<p>所以如果我们想要截获命令行的所有输出标准输出信息的话，就应该采用如下写法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">$ls</span> <span class="o">&gt;</span><span class="n">t</span><span class="o">.</span><span class="na">txt</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</span></code></pre></td></tr></table></div></figure>


<p>有次，移植python的时候，遇到些问题，需要看看configure的流程，看到了另外一种写法：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">exec</span> <span class="mi">5</span><span class="o">&gt;&gt;</span> <span class="n">config</span><span class="o">.</span><span class="na">log</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">6</span><span class="o">&gt;&gt;</span> <span class="n">Setup</span><span class="o">.</span><span class="na">config</span>
</span><span class='line'><span class="n">echo</span> <span class="s">&quot;hello&quot;</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="mi">5</span>
</span><span class='line'><span class="n">echo</span> <span class="s">&quot;test config&quot;</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="mi">6</span>
</span></code></pre></td></tr></table></div></figure>


<p>这样就可以实现向不同的文件写入详细的过程，而不会污染configure执行过程的输出信息了。
更巧妙的是，如果你是再改造一个已经混乱不堪，输出非常乱的脚本，你可以把标准输出重定向到文件，而自己用一个重定向的句柄来接管标准输出，如下：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">echo</span> <span class="s">&quot;first I am in stdout&quot;</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">3</span><span class="o">&gt;&gt;</span> <span class="n">t</span><span class="o">.</span><span class="na">log</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">4</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">5</span><span class="o">&gt;&amp;</span><span class="mi">2</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">1</span><span class="o">&gt;&amp;</span><span class="mi">3</span>
</span><span class='line'><span class="n">exec</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">3</span>
</span><span class='line'><span class="n">echo</span> <span class="s">&quot;seconf I am not in stdout&quot;</span>
</span><span class='line'><span class="n">echo</span> <span class="s">&quot;third I am in stdout&quot;</span><span class="o">&gt;&amp;</span><span class="mi">4</span>
</span><span class='line'><span class="n">echo</span> <span class="s">&quot;fourth I am in stderr&quot;</span><span class="o">&gt;&amp;</span><span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure>


<p>题外话：
在调试复杂脚本的时候，很难跟踪流程，可以使用trap命令来很方便的跟踪流程</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="n">trap</span> <span class="err">&#39;</span><span class="n">echo</span> <span class="err">“</span><span class="n">before</span> <span class="n">execute</span> <span class="nl">line:</span><span class="n">$LINENO</span><span class="o">,</span> <span class="n">a</span><span class="o">=</span><span class="n">$a</span><span class="o">,</span><span class="n">b</span><span class="o">=</span><span class="n">$b</span><span class="o">,</span><span class="n">c</span><span class="o">=</span><span class="n">$c</span><span class="err">”&#39;</span> <span class="n">DEBUG</span>
</span></code></pre></td></tr></table></div></figure>


<p>trap捕捉到信号之后，可以有三种反应方式：</p>

<blockquote><ol>
<li>执行一段程序来处理这一信号</li>
<li>接受信号的默认操作</li>
<li>忽视这一信号</li>
</ol>
</blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/28/sync-data/">远程数据同步及操作方法</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-28T23:44:31+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>11:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>python fabric</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>待补充</span></code></pre></td></tr></table></div></figure>


<h1>Winscp远程同步数据脚本</h1>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># winscp.exe /console /script=sample.txt 
</span><span class='line'>
</span><span class='line'># Automatically answer all prompts negatively not to stall
</span><span class='line'># the script on errors
</span><span class='line'># option echo  on|off
</span><span class='line'>option echo off
</span><span class='line'>
</span><span class='line'># option batch on|off|abort|continue
</span><span class='line'>option batch on
</span><span class='line'>
</span><span class='line'># option confirm  on|off
</span><span class='line'>option confirm off
</span><span class='line'>
</span><span class='line'># option transfer  binary|ascii|automatic
</span><span class='line'># option synchdelete  on|off
</span><span class='line'># option exclude clear | &lt;mask&gt;[;&lt;mask2&gt;...]
</span><span class='line'># option include clear | &lt;mask&gt;[;&lt;mask2&gt;...]
</span><span class='line'>
</span><span class='line'># open [ sftp|ftp|scp:// ][ &lt;user&gt; [ :password ] @ ] &lt;host&gt; [ :&lt;port&gt; ]
</span><span class='line'># open user:password@example.com
</span><span class='line'># Connect   FTP地址
</span><span class='line'>open sftp://root:password#@42.xx.xx.xxx:22
</span><span class='line'>
</span><span class='line'># Change remote directory
</span><span class='line'>cd /root/iskey/work/enzo2   
</span><span class='line'>#如果同步到远程FTP时,可用此命令转到远程某个目录下.
</span><span class='line'>
</span><span class='line'># Change local directory
</span><span class='line'># set to Self's working dir  设置需要同步到远程FTP的本地文件目录
</span><span class='line'>lcd F:\vms\vagrant_work\Django\enzo
</span><span class='line'>
</span><span class='line'># Force binary mode transfer
</span><span class='line'>option transfer ascii
</span><span class='line'>
</span><span class='line'># Download file to the local directory d:\
</span><span class='line'># get examplefile.txt d:\
</span><span class='line'>
</span><span class='line'># option synchdelete  on|off
</span><span class='line'>option synchdelete off
</span><span class='line'>
</span><span class='line'># option include clear | &lt;mask&gt;[;&lt;mask2&gt;...]
</span><span class='line'>synchronize remote -filemask="|*.pyc; .git\; .idea\; .cache\; .autojump\; .\idea\; .local\; .ipython\; venv\"
</span><span class='line'>
</span><span class='line'>
</span><span class='line'># synchronize local|remote|both [ &lt;local directory&gt; [ &lt;remote directory&gt; ] ]  从远程同步到本地用Local;从本地同步到远程用Remote
</span><span class='line'>#synchronize remote  
</span><span class='line'>
</span><span class='line'># Disconnect
</span><span class='line'>close
</span><span class='line'>
</span><span class='line'># Exit WinSCP
</span><span class='line'>exit
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用命令：
<code>C:\...\winscp577\WinSCP.exe /console /script=C:\...\enzo2.txt</code></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/28/use-ftrace/">内核使用ftrace</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-28T23:44:00+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>28</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>11:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='java'><span class='line'><span class="err">#</span><span class="o">!/</span><span class="n">bin</span><span class="o">/</span><span class="n">sh</span>
</span><span class='line'><span class="n">ROOT_DEBUGFS</span><span class="o">=</span><span class="s">&quot;/debug&quot;</span>
</span><span class='line'><span class="n">ROOT_FTRACE</span><span class="o">=</span><span class="s">&quot;${ROOT_DEBUGFS}/tracing&quot;</span>
</span><span class='line'><span class="err">#</span><span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">debugfs</span> <span class="n">nodev</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_DEBUGFS</span><span class="o">}</span>
</span><span class='line'><span class="n">echo</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">trace</span>
</span><span class='line'><span class="n">echo</span> <span class="n">$$</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">set_ftrace_pid</span>
</span><span class='line'><span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">tracing_enabled</span>
</span><span class='line'><span class="n">echo</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">tracing_on</span>
</span><span class='line'><span class="err">#</span> <span class="n">can</span> <span class="n">set</span> <span class="n">other</span> <span class="n">filtering</span> <span class="n">here</span>
</span><span class='line'><span class="n">echo</span> <span class="n">function</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">current_tracer</span>
</span><span class='line'><span class="n">echo</span> <span class="n">start_trace_marker</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">trace_marker</span>
</span><span class='line'><span class="n">exec</span> <span class="n">$</span><span class="o">*</span>
</span><span class='line'><span class="n">echo</span> <span class="n">end_trace_marker</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">trace_marker</span>
</span><span class='line'><span class="n">echo</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">tracing_on</span>
</span><span class='line'><span class="n">echo</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">$</span><span class="o">{</span><span class="n">ROOT_FTRACE</span><span class="o">}/</span><span class="n">tracing_enabled</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/27/open-switch-ONIE/">开源交换机安装环境ONIE</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-27T03:46:31+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2016</span></span> <span class='time'>3:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>Onie 安装及引导流程</h1>

<hr />

<h2>ONIE简要说明</h2>

<hr />

<p>ONIE是The Open Network Install Environment的简写，目的是为裸板网络交换机提供一个开源的安装环境，ONIE提供了一个灵活的白盒交换机生态系统使最终用户可以自主选择不同的网络操作系统。</p>

<p>通常，购买来的交换机都已经预装了一个由厂家自己垄断的操作系统，使得用户把自己的网络架构都限定在一个垂直的供应链上。于是整个行业都开始探索“白盒”交换机的可能，其中一个需要解决的问题就是如何让交换机支持不同的网络操作系统，（这正式ONIE的目标）。</p>

<p>按照惯例，这些交换机包换一个基于不同CPU架构的管理子系统，一般都会包含一个串行控制口，带外以太网口，有时还包含一个可插拔的大容量存储设备。这个子系统可以作为一个独立的功能与交换机的ASIC(s)及前端控制台界面分离开来。</p>

<p>ONIE利用linux/busybox等开源项目定义了一套开源的“安装环境”来驱动这个管理子系统。在此“安装环境”下，终端用户和渠道伙伴可以像安装服务器一样，把NOS作为一个单独的数据中心供应件安装在“白盒”交换机设备上。</p>

<p>ONIE使得交换机硬件供应商、分销商和转销商通过自己的管理来减少自己的库存，这将会在制造商、分销商、库存方面产生规模经济效应。并促进网络设备和网络操作系统的空前繁荣。</p>

<p><strong>ONIE特点</strong></p>

<blockquote><ul>
<li>组合了bootloader、比较新的Linux 内核和Busybox</li>
<li>提供了一个可以安装任意NOS的安装环境</li>
<li>把终端用户从预装的、垄断的Nos中解放出来</li>
<li>有助于实现数据中心的大规模的交换机需求的自动化维护</li>
<li>使你可以像管理服务器一样管理你的交换机</li>
</ul>
</blockquote>

<h2>制作ONIE镜像</h2>

<hr />

<h3>设备定义文件</h3>

<p>在编译某个特定平台的ONIE镜像时，需要预先定义一些这个平台的设备宏，这些宏位于$ONIE_ROOT/machine/<code>&lt;vender&gt;</code>/<code>&lt;vendor&gt;_&lt;model&gt;</code>.</p>

<p>关于特定平台附件信息可以参考位于machine/<code>&lt;vendor&gt;</code>/<code>&lt;vendor&gt;_&lt;model&gt;</code>下的INSTALL文件</p>

<h3>准备编译环境</h3>

<p>在准备一台新的编译环境时，ONIE依赖一些标准的开发工具包。
对于<strong>Debian-based System</strong>，我们已经准备好了一个<strong>Makefile</strong>目标，可以帮助你自动安装ONIE所依赖的工具包，ONIE会根据当前稳定版本的Debian系统来维护这个<strong>Makefile</strong>目标，此<strong>Makefile</strong>目标需要使用<strong>sudo(8)</strong>命令并要求当前用户具有<strong>root</strong>权限。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd build-config 
</span><span class='line'>$ sudo apt-get update 
</span><span class='line'>$ sudo apt-get install build-essential
</span><span class='line'>$ make debian-prepare-build-host</span></code></pre></td></tr></table></div></figure>


<p>对于不同的Linux分发版本，可以参考<strong>Makefile</strong>的<code>(DEBIAN_BUILD_HOST_PACKAGES)</code>变量，使用相应分发版本的包管理工具来安装这些工具包。</p>

<h3>准备一个新的构建用户账号</h3>

<p>构建账号的环境变量<code>$PATH</code>必须包含<code>/sbin</code>和<code>/usr/sbin</code>，如果使用的是<code>bash</code>shell，可以下<code>$HOME/.bashrc</code>文件的末尾添加如下语句：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>export PATH="/sbin:/usr/sbin:$PATH" </span></code></pre></td></tr></table></div></figure>


<h3>交叉编译工具链</h3>

<p>ONIE的构建过程会生成并使用一套基于<code>gcc</code>和<code>uClibc</code>的交叉工具链，<code>crosstool-NG</code>是专门用来管理这套工具链的构建的工程。</p>

<p>构建过程，ONIE需要从Ineternet下载一系列的包文件.你可以把这些包文件放到你的本地镜像服务器（本地镜像通过<code>onie/build-config/local.make</code>进行设置）,你可以参考ONIE自带的例子，<code>onie/build-config/local.make.example</code>，和<code>ONIE_MIRROR</code>、<code>CROSSTOOL_ONIE_MIRROR</code>变量。</p>

<p>可以参考FAQ实例<a href="https://github.com/opencomputeproject/onie/wiki/FAQ#can-i-set-up-a-local-cache-of-downloaded-packages-onie-needs">caching downloaded packages</a></p>

<h3>交叉编译ONIE</h3>

<p>编译ONIE,第一步切换到<code>build-config</code>目录，然后输入<code>make MACHINEROOT=../machine/&lt;vendor&gt; MACHINE=&lt;vendor&gt;_&lt;model&gt; all</code>，指定目标设备。</p>

<p>如下：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ cd buid-config
</span><span class='line'>$ make -j4 MACHINDROOT=../machine/&lt;vendor&gt; MACHINE=&lt;vendor&gt;_&lt;model&gt; all</span></code></pre></td></tr></table></div></figure>


<p>编译完成后，在<code>build/images</code>目录下已经生成了ONIE 二进制文件。</p>

<table>
<thead>
<tr>
<th> 文件  </th>
<th>   目的    </th>
</tr>
</thead>
<tbody>
<tr>
<td>onie-<code>&lt;platform&gt;</code>-<code>&lt;version&gt;</code>.bin</td>
<td> Raw binary, suitable for NOR flash programming</td>
</tr>
<tr>
<td>onie-updater-<code>&lt;platform&gt;</code>-<code>&lt;revision&gt;</code></td>
<td>ONIE updater, for use with the ONIE update mechanism</td>
</tr>
</tbody>
</table>


<h3>制作ONIE启动安装盘</h3>

<p>详细的关于ONIE启动安装盘制作过程可以进一步阅读<code>machin/&lt;platform&gt;</code>目录下的<code>INSTALL</code>文件。</p>

<p>build目录一般会生成一个iso（或bin）文件，这个iso（或bin）文件可以用来：</p>

<blockquote><ul>
<li>设备厂商用来初始化安装一个新的空设备。</li>
<li>修复被损坏的ONIE 操作系统</li>
</ul>
</blockquote>

<p>通常会把iso文件烧写到U盘来使用，可以使用如下命令：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ dd if=&lt;machine&gt;.iso of=/dev/sdX bs=10M</span></code></pre></td></tr></table></div></figure>


<h2>FAQ</h2>

<hr />

<blockquote><ol>
<li>ONIE多久发布一次？
<br>ONIE每三个月会发布一次，详细信息，请移步<strong>代码更新周期</strong>章节。</li>
<li>我有一台从XYZ厂商购买的交换机，没有安装ONIE，我可以自己安装吗？
<br>简单的说，不能。</li>
<li>为什么默认的Console的波特率是115200？
<br>
这都21世纪了，为什么不用一个合理的较快的波特率呢?</li>
</ol>
</blockquote>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/03/03/broadcast/">组播通讯实例</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-03-03T16:26:00+00:00'><span class='date'><span class='date-month'>Mar</span> <span class='date-day'>3</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>4:26 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>sender.c</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;  
</span><span class='line'>#include &lt;sys/types.h&gt;  
</span><span class='line'>#include &lt;sys/socket.h&gt;  
</span><span class='line'>#include &lt;netinet/in.h&gt;  
</span><span class='line'>#include &lt;arpa/inet.h&gt;  
</span><span class='line'>#include &lt;time.h&gt;  
</span><span class='line'>#include &lt;string.h&gt;  
</span><span class='line'>#include &lt;stdio.h&gt;  
</span><span class='line'>#include &lt;unistd.h&gt;  
</span><span class='line'>  
</span><span class='line'>#define HELLO_PORT 12345  
</span><span class='line'>#define HELLO_GROUP "225.0.0.37"  
</span><span class='line'>  
</span><span class='line'>int main(int argc, char *argv[])  
</span><span class='line'>{  
</span><span class='line'>  struct sockaddr_in addr;  
</span><span class='line'>  int fd, cnt;  
</span><span class='line'>  struct ip_mreq mreq;  
</span><span class='line'>  char *message="Hello, World!";  
</span><span class='line'>  
</span><span class='line'>  /* create what looks like an ordinary UDP socket */  
</span><span class='line'>  if ((fd=socket(AF_INET,SOCK_DGRAM,0)) &lt; 0)   
</span><span class='line'>  {  
</span><span class='line'>      perror("socket");  
</span><span class='line'>      exit(1);  
</span><span class='line'>  }  
</span><span class='line'>  
</span><span class='line'>  /* set up destination address */  
</span><span class='line'>  memset(&addr,0,sizeof(addr));  
</span><span class='line'>  addr.sin_family=AF_INET;  
</span><span class='line'>  addr.sin_addr.s_addr=inet_addr(HELLO_GROUP);  
</span><span class='line'>  addr.sin_port=htons(HELLO_PORT);  
</span><span class='line'>  
</span><span class='line'>  /* now just sendto() our destination! */  
</span><span class='line'>  while (1)  
</span><span class='line'>  {  
</span><span class='line'>      if (sendto(fd,message, strlen(message), 0, (struct sockaddr *) &addr, sizeof(addr)) &lt; 0)   
</span><span class='line'>      {  
</span><span class='line'>          perror("sendto");  
</span><span class='line'>          exit(1);  
</span><span class='line'>      }  
</span><span class='line'>      sleep(1);  
</span><span class='line'>  }  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>receiver.c</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;  
</span><span class='line'>#include &lt;sys/types.h&gt;  
</span><span class='line'>#include &lt;sys/socket.h&gt;  
</span><span class='line'>#include &lt;netinet/in.h&gt;  
</span><span class='line'>#include &lt;arpa/inet.h&gt;  
</span><span class='line'>#include &lt;time.h&gt;  
</span><span class='line'>#include &lt;string.h&gt;  
</span><span class='line'>#include &lt;stdio.h&gt;  
</span><span class='line'>#include &lt;unistd.h&gt;  
</span><span class='line'>  
</span><span class='line'>#define HELLO_PORT  12345  
</span><span class='line'>#define HELLO_GROUP "225.0.0.37"  
</span><span class='line'>#define MSGBUFSIZE 256  
</span><span class='line'>  
</span><span class='line'>int main(int argc, char *argv[])  
</span><span class='line'>{  
</span><span class='line'>  struct sockaddr_in addr;  
</span><span class='line'>  int fd, nbytes,addrlen;  
</span><span class='line'>  struct ip_mreq mreq;  
</span><span class='line'>  char msgbuf[MSGBUFSIZE];  
</span><span class='line'>  
</span><span class='line'>  u_int yes=1; /*** MODIFICATION TO ORIGINAL */  
</span><span class='line'>  
</span><span class='line'>  /* create what looks like an ordinary UDP socket */  
</span><span class='line'>  if ((fd=socket(AF_INET,SOCK_DGRAM,0)) &lt; 0)   
</span><span class='line'>  {  
</span><span class='line'>      perror("socket");  
</span><span class='line'>      exit(1);  
</span><span class='line'>  }  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>  /**** MODIFICATION TO ORIGINAL */  
</span><span class='line'>  /* allow multiple sockets to use the same PORT number */  
</span><span class='line'>  if (setsockopt(fd,SOL_SOCKET,SO_REUSEADDR,&yes,sizeof(yes)) &lt; 0)   
</span><span class='line'>  {  
</span><span class='line'>      perror("Reusing ADDR failed");  
</span><span class='line'>      exit(1);  
</span><span class='line'>  }  
</span><span class='line'>  /*** END OF MODIFICATION TO ORIGINAL */  
</span><span class='line'>  
</span><span class='line'>  /* set up destination address */  
</span><span class='line'>  memset(&addr,0,sizeof(addr));  
</span><span class='line'>  addr.sin_family=AF_INET;  
</span><span class='line'>  addr.sin_addr.s_addr=htonl(INADDR_ANY); /* N.B.: differs from sender */  
</span><span class='line'>  addr.sin_port=htons(HELLO_PORT);  
</span><span class='line'>  
</span><span class='line'>  /* bind to receive address */  
</span><span class='line'>  if (bind(fd,(struct sockaddr *) &addr,sizeof(addr)) &lt; 0)  
</span><span class='line'>  {  
</span><span class='line'>      perror("bind");  
</span><span class='line'>      exit(1);  
</span><span class='line'>  }  
</span><span class='line'>  
</span><span class='line'>  /* use setsockopt() to request that the kernel join a multicast group */  
</span><span class='line'>  mreq.imr_multiaddr.s_addr=inet_addr(HELLO_GROUP);  
</span><span class='line'>  mreq.imr_interface.s_addr=htonl(INADDR_ANY);  
</span><span class='line'>  if (setsockopt(fd,IPPROTO_IP,IP_ADD_MEMBERSHIP,&mreq,sizeof(mreq)) &lt; 0)   
</span><span class='line'>  {  
</span><span class='line'>      perror("setsockopt");  
</span><span class='line'>      exit(1);  
</span><span class='line'>  }  
</span><span class='line'>  
</span><span class='line'>  /* now just enter a read-print loop */  
</span><span class='line'>  while (1)   
</span><span class='line'>  {  
</span><span class='line'>      addrlen=sizeof(addr);  
</span><span class='line'>      if ((nbytes=recvfrom(fd,msgbuf,MSGBUFSIZE,0, (struct sockaddr *) &addr,(socklen_t*)&addrlen)) &lt; 0)   
</span><span class='line'>      {  
</span><span class='line'>          perror("recvfrom");  
</span><span class='line'>          exit(1);  
</span><span class='line'>      }  
</span><span class='line'>      puts(msgbuf);  
</span><span class='line'>  }  
</span><span class='line'>  
</span><span class='line'>  return 0;  
</span><span class='line'>}  </span></code></pre></td></tr></table></div></figure>


<h4>Makefile</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CC = gcc  
</span><span class='line'>CXX = g++  
</span><span class='line'>CFLAGS = -Wall -D_DEBUG -DDEBUG -g -O0  
</span><span class='line'>LDFLAGS =   
</span><span class='line'>  
</span><span class='line'>MODULE_INC = -I/usr/include  
</span><span class='line'>MODULE_LIB = -L/usr/lib  
</span><span class='line'>  
</span><span class='line'>CFLAGS  += $(MODULE_INC)  
</span><span class='line'>LDFLAGS += $(MODULE_LIB)  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>SENDOBJS = sender.o  
</span><span class='line'>RECVOBJS = receiver.o  
</span><span class='line'>  
</span><span class='line'>  
</span><span class='line'>TARGET = sender receiver  
</span><span class='line'>  
</span><span class='line'>all: $(TARGET)  
</span><span class='line'>  
</span><span class='line'>sender: $(SENDOBJS)  
</span><span class='line'>
</span><span class='line'>  $(CXX) -o $@ $^ $(LDFLAGS)  
</span><span class='line'>  
</span><span class='line'>receiver: $(RECVOBJS)  
</span><span class='line'>  
</span><span class='line'>  $(CXX) -o $@ $^ $(LDFLAGS)  
</span><span class='line'>  
</span><span class='line'>clean:   
</span><span class='line'>  rm -f *.o 
</span><span class='line'>  rm -f $(TARGET)  
</span><span class='line'>  rm -f http/*.o  
</span><span class='line'># make rule  
</span><span class='line'>%.o : %.c  
</span><span class='line'>  $(CC) $(CFLAGS) -c $^ -o $@   
</span><span class='line'>  
</span><span class='line'>%.o : %.cpp  
</span><span class='line'>  $(CC) $(CFLAGS) -c $^ -o $@  </span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/23/OCP-open-switch-ONIE/">OCP开源交换机之ONIE杂记</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2016-01-23T03:46:31+00:00'><span class='date'><span class='date-month'>Jan</span> <span class='date-day'>23</span><span class='date-suffix'>rd</span>, <span class='date-year'>2016</span></span> <span class='time'>3:46 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>OCP全称是Open Computer Project，是Facebook发起并主导的一个硬件开源组织。该组织主要关注数据中心产品的开源及共享，标准化产品的硬件设计，以期打破数据中心产品提供商的硬件壁垒，从而降低成本，提高效率。</p>

<p>目前该组织关注的产品包括，存储设备、服务器主板、服务器机柜、虚拟I/O、硬件驱动管理、数据中心基础架构设计、三层交换机等。</p>

<p>ONIE软件相当于一个集成众多工具包的微型Linux系统，通过这个微型Linux环境，可以安装和启动符合要求的交换机软件系统。
如此依赖，交换机被分割为两个独立的部分，OCP组织负责指定硬件设计规范，代工厂商，如天弘等根据规范生产硬件。软件厂商适配自己的交换机系统到OCP硬件上，这样组合起来的交换机就是白牌交换机。</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/10/06/svn-snapshot/">Svn源码树快照生成工具</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-10-06T01:49:12+00:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>6</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>1:49 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>项目的源码管理工具使用的是SVN，由于涉及的项目组众多，源码库功能模块分散在众多小的源码库中，最终的项目源码发布需要从各个源码库中抓取分支，然后版本发布。</p>

<p>这就给版本管理员带来了麻烦，发布版本的时候，需要从各个源码库抓取源码，然后进行编译，调试过程中出现问题，就在需要更新出问题的源码分支，甚至有可能会临时的修改源码中的某一些文件。</p>

<p>开发人员如果想要使用某一个版本的源码，一般把版本管理员发布的源码包下载下来，然后在进行Bug定位和跟踪，由于源码量比较大，所以造成了很大的不方便。</p>

<p>所以编写了下边的源码快照工具，有以下功能：</p>

<ul>
<li>遍历所有的源码库，获取并记录所有的源码库当前版本号</li>
<li>记录当前源码库中，新修改提交的文件版本号。（svn 只更新提交了的个别文件）</li>
<li>记录当前临时修改，但没有提交的代码，并生成patch文件放到patches/目录。</li>
<li>对于无法生成patch的二进制文件，则拷贝到patches/目录。</li>
<li>生成snapshot.sh脚本，这个脚本包含了当前svn源码树的快照信息。</li>
</ul>


<p>在任意的项目SVN源码树，把前边输出的snapshot.sh和patches/目录放到这个源码树的根目录，执行snapshot.就可以恢复到相应的快照状态。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>### exec this scripts in root directory.
</span><span class='line'>### the snapshot of the work copy will be saved to $OUT.
</span><span class='line'>
</span><span class='line'>OUT=$(pwd)/snapshot.sh
</span><span class='line'>PATCH_DIR=$(pwd)/patches
</span><span class='line'>EAT=$(pwd)/eat
</span><span class='line'>patch_idx=0
</span><span class='line'>mime_file_idx=0
</span><span class='line'>
</span><span class='line'>echo "### V3.02.20 svn snapshot scripts ###" &gt;$OUT
</span><span class='line'>echo "PATCH_DIR=\$(pwd)/patches" &gt;&gt;$OUT
</span><span class='line'>
</span><span class='line'>echo -e "\ncheck_svn_tree()
</span><span class='line'>{
</span><span class='line'>f_temp=\$1
</span><span class='line'>f_temp=\${f_temp%/*}
</span><span class='line'>if ! test -d \$f_temp
</span><span class='line'>then
</span><span class='line'>  while( ! test -d  \${f_temp%/*})
</span><span class='line'>  do
</span><span class='line'>      f_last=\$f_temp
</span><span class='line'>      f_temp=\${f_temp%/*}
</span><span class='line'>      if [ \"\$f_last\" = \"\$f_temp\" ]
</span><span class='line'>      then
</span><span class='line'>          break
</span><span class='line'>      fi
</span><span class='line'>  done
</span><span class='line'>  echo \"will update \$f_temp\"
</span><span class='line'>  svn update \$f_temp
</span><span class='line'>fi
</span><span class='line'>}\n" &gt;&gt;$OUT
</span><span class='line'>
</span><span class='line'>#Prepare eat program for svn diff.
</span><span class='line'>touch $EAT
</span><span class='line'>chmod a+x $EAT
</span><span class='line'>
</span><span class='line'>rm $PATCH_DIR -fr
</span><span class='line'>mkdir -p $PATCH_DIR
</span><span class='line'>
</span><span class='line'>#Find svn repositories.
</span><span class='line'>#svn_repos=$(find ./ -name '*.svn' -type d -print)
</span><span class='line'>svn_repos="./ "
</span><span class='line'>svn_repos+=$(svn status | grep ^Perf | cut -d\' -f 2)
</span><span class='line'>for svn_repo in $svn_repos
</span><span class='line'>do
</span><span class='line'>  #svn_dir=${svn_repo%/*}
</span><span class='line'>  svn_dir=$svn_repo
</span><span class='line'>  cd $svn_dir
</span><span class='line'>  #Get svn local copy's revision.
</span><span class='line'>  REV=$(svn info . | sed -n '/Revision:/p' | awk '{print $2}')
</span><span class='line'>  echo "cd $svn_dir"
</span><span class='line'>  echo "cd $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "echo Cleaning: $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st | grep '^?' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st --no-ignore | grep '^I' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "echo Reverting: $svn_dir" &gt;&gt;$OUT
</span><span class='line'>  echo "svn cleanup" &gt;&gt;$OUT
</span><span class='line'>  echo "svn revert . -R" &gt;&gt;$OUT
</span><span class='line'>  echo "svn update . -r $REV" &gt;&gt;$OUT
</span><span class='line'>  echo "svn revert . -R" &gt;&gt;$OUT
</span><span class='line'>  
</span><span class='line'>  #Get svn local copy's changed files.
</span><span class='line'>  M_LIST=$(svn diff -r BASE:COMMITTED --diff-cmd $EAT | sed -n '/Index:/p' | awk '{print $2}')
</span><span class='line'>  for svn_file in $M_LIST
</span><span class='line'>  do
</span><span class='line'>      echo "  Changed File: "$svn_file
</span><span class='line'>      #Get changed file's revision.
</span><span class='line'>      file_rev=$(svn info $svn_file | sed -n '/Last Changed Rev:/p' | awk '{print $4}')
</span><span class='line'>      echo "#----------" &gt;&gt;$OUT
</span><span class='line'>      echo "svn revert $svn_file &gt;/dev/null 2&gt;&1" &gt;&gt;$OUT
</span><span class='line'>      echo "check_svn_tree $svn_file" &gt;&gt;$OUT
</span><span class='line'>      echo "svn update -r $file_rev $svn_file" &gt;&gt;$OUT
</span><span class='line'>      echo "svn revert $svn_file" &gt;&gt;$OUT
</span><span class='line'>  done
</span><span class='line'>  
</span><span class='line'>  #Clean again after revert.
</span><span class='line'>  echo "svn st | grep '^?' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  echo "svn st --no-ignore | grep '^I' | awk '{print $2}' | xargs -I{} rm -rf '{}'" &gt;&gt;$OUT
</span><span class='line'>  
</span><span class='line'>  #Get temporary patches
</span><span class='line'>  PATCH_FILES=$(svn diff . --diff-cmd $EAT | sed -n '/Index:/p' | awk '{print $2}')
</span><span class='line'>  if [ ""x != "$PATCH_FILES"x ];then
</span><span class='line'>      let patch_idx+=1
</span><span class='line'>      echo "#==========" &gt;&gt;$OUT
</span><span class='line'>      svn diff . &gt;$PATCH_DIR/$patch_idx.patch
</span><span class='line'>      echo "patch -p0 &lt;\$PATCH_DIR/$patch_idx.patch" &gt;&gt;$OUT
</span><span class='line'>  fi
</span><span class='line'>  
</span><span class='line'>  for mime_file in $PATCH_FILES
</span><span class='line'>  do
</span><span class='line'>      mime_type=$(svn pl $mime_file | sed -n '/svn:mime-type/p')
</span><span class='line'>      if [ ""x != "$mime_type"x ];then
</span><span class='line'>          let mime_file_idx+=1
</span><span class='line'>          cp $mime_file $PATCH_DIR/${mime_file_idx}_${mime_file##*/} -fr
</span><span class='line'>          echo "#==========" &gt;&gt;$OUT
</span><span class='line'>          echo "cp \$PATCH_DIR/${mime_file_idx}_${mime_file##*/} $mime_file -f" &gt;&gt;$OUT
</span><span class='line'>      fi
</span><span class='line'>  done
</span><span class='line'>  
</span><span class='line'>  echo "cd -&gt;/dev/null" &gt;&gt; $OUT
</span><span class='line'>  echo "" &gt;&gt;$OUT
</span><span class='line'>  echo "###############"&gt;&gt; $OUT
</span><span class='line'>  echo "" &gt;&gt;$OUT
</span><span class='line'>  cd - &gt; /dev/null
</span><span class='line'>done</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/13/python-get-current-line-number/">Python获取当前行号</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-09-13T23:44:00+00:00'><span class='date'><span class='date-month'>Sep</span> <span class='date-day'>13</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>11:44 pm</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>对于python，这几天一直有两个问题在困扰我:
- <strong>python中没办法直接取得当前的行号和函数名?</strong>,
这是有人在论坛里提出的问题，底下一群人只是在猜测python为什么不像<strong>file</strong>一样提供<strong>line</strong>和<strong>func</strong>，但是却最终也没有找到解决方案。
- <strong>如果一个函数在不知道自己名字的情况下，怎么才能递归调用自己</strong>。
这是我一个同事问我的，其实也是获取函数名，但是当时也是回答不出来。</p>

<p>但是今晚！所有的问题都有了答案。
一切还要从我用python的logging模块说起，logging中的format中是有如下选项的:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>%(name)s            Name of the logger (logging channel)
</span><span class='line'>%(levelno)s         Numeric logging level for the message (DEBUG, INFO,
</span><span class='line'>                    WARNING, ERROR, CRITICAL)
</span><span class='line'>%(levelname)s       Text logging level for the message ("DEBUG", "INFO",
</span><span class='line'>                    "WARNING", "ERROR", "CRITICAL")
</span><span class='line'>%(pathname)s        Full pathname of the source file where the logging
</span><span class='line'>                    call was issued (if available)
</span><span class='line'>%(filename)s        Filename portion of pathname
</span><span class='line'>%(module)s          Module (name portion of filename)
</span><span class='line'>%(lineno)d          Source line number where the logging call was issued
</span><span class='line'>                    (if available)
</span><span class='line'>%(funcName)s        Function name
</span><span class='line'>%(created)f         Time when the LogRecord was created (time.time()
</span><span class='line'>                    return value)
</span><span class='line'>%(asctime)s         Textual time when the LogRecord was created
</span><span class='line'>%(msecs)d           Millisecond portion of the creation time
</span><span class='line'>%(relativeCreated)d Time in milliseconds when the LogRecord was created,
</span><span class='line'>                    relative to the time the logging module was loaded
</span><span class='line'>                    (typically at application startup time)
</span><span class='line'>%(thread)d          Thread ID (if available)
</span><span class='line'>%(threadName)s      Thread name (if available)
</span><span class='line'>%(process)d         Process ID (if available)
</span><span class='line'>%(message)s         The result of record.getMessage(), computed just as
</span><span class='line'>                    the record is emitted</span></code></pre></td></tr></table></div></figure>


<p>也就是说，logging是能够获取到调用者的行号和函数名的，那会不会也可以获取到自己的行号和函数名呢？
我们来看一下源码，主要部分如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>def currentframe():
</span><span class='line'>    """Return the frame object for the caller's stack frame."""
</span><span class='line'>    try:
</span><span class='line'>        raise Exception
</span><span class='line'>    except:
</span><span class='line'>        return sys.exc_info()[2].tb_frame.f_back
</span><span class='line'>def findCaller(self):
</span><span class='line'>    """
</span><span class='line'>    Find the stack frame of the caller so that we can note the source
</span><span class='line'>    file name, line number and function name.
</span><span class='line'>    """
</span><span class='line'>    f = currentframe()
</span><span class='line'>    #On some versions of IronPython, currentframe() returns None if
</span><span class='line'>    #IronPython isn't run with -X:Frames.
</span><span class='line'>    if f is not None:
</span><span class='line'>        f = f.f_back
</span><span class='line'>    rv = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    while hasattr(f, "f_code"):
</span><span class='line'>        co = f.f_code
</span><span class='line'>        filename = os.path.normcase(co.co_filename)
</span><span class='line'>        if filename == _srcfile:
</span><span class='line'>            f = f.f_back
</span><span class='line'>            continue
</span><span class='line'>        rv = (co.co_filename, f.f_lineno, co.co_name)
</span><span class='line'>        break
</span><span class='line'>    return rv
</span><span class='line'>def _log(self, level, msg, args, exc_info=None, extra=None):
</span><span class='line'>    """
</span><span class='line'>    Low-level logging routine which creates a LogRecord and then calls
</span><span class='line'>    all the handlers of this logger to handle the record.
</span><span class='line'>    """
</span><span class='line'>    if _srcfile:
</span><span class='line'>        #IronPython doesn't track Python frames, so findCaller throws an
</span><span class='line'>        #exception on some versions of IronPython. We trap it here so that
</span><span class='line'>        #IronPython can use logging.
</span><span class='line'>        try:
</span><span class='line'>            fn, lno, func = self.findCaller()
</span><span class='line'>        except ValueError:
</span><span class='line'>            fn, lno, func = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    else:
</span><span class='line'>        fn, lno, func = "(unknown file)", 0, "(unknown function)"
</span><span class='line'>    if exc_info:
</span><span class='line'>        if not isinstance(exc_info, tuple):
</span><span class='line'>            exc_info = sys.exc_info()
</span><span class='line'>    record = self.makeRecord(self.name, level, fn, lno, msg, args, exc_info, func, extra)
</span><span class='line'>    self.handle(record)</span></code></pre></td></tr></table></div></figure>


<p>我简单解释一下，实际上是通过在currentframe函数中抛出一个异常，然后通过向上查找的方式，找到调用的信息。其中</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>rv = (co.co_filename, f.f_lineno, co.co_name)</span></code></pre></td></tr></table></div></figure>


<p>的三个值分别为文件名，行号，函数名。(可以去<a href="http://docs.python.org/library/sys.html">http://docs.python.org/library/sys.html</a> 来看一下代码中几个系统函数的说明)
OK，如果已经看懂了源码，那获取当前位置的行号和函数名相信也非常清楚了，代码如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/usr/bin/python
</span><span class='line'># -*- coding: utf-8 -*-
</span><span class='line'>'''
</span><span class='line'>#=============================================================================
</span><span class='line'>#  Author:          dantezhu - http://www.vimer.cn
</span><span class='line'>#  Email:           zny2008@gmail.com
</span><span class='line'>#  FileName:        xf.py
</span><span class='line'>#  Description:     获取当前位置的行号和函数名
</span><span class='line'>#  Version:         1.0
</span><span class='line'>#  LastChange:      2010-12-17 01:19:19
</span><span class='line'>#  History:         
</span><span class='line'>#=============================================================================
</span><span class='line'>'''
</span><span class='line'>import sys
</span><span class='line'>def get_cur_info():
</span><span class='line'>    """Return the frame object for the caller's stack frame."""
</span><span class='line'>    try:
</span><span class='line'>        raise Exception
</span><span class='line'>    except:
</span><span class='line'>        f = sys.exc_info()[2].tb_frame.f_back
</span><span class='line'>    return (f.f_code.co_name, f.f_lineno)
</span><span class='line'>
</span><span class='line'>def callfunc():
</span><span class='line'>    print get_cur_info()
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>if __name__ == '__main__':
</span><span class='line'>    callfunc()</span></code></pre></td></tr></table></div></figure>


<p>输出结果是：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>('callfunc', 24)</span></code></pre></td></tr></table></div></figure>


<p>后来发现，其实也可以有更简单的方法，如下:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>import sys
</span><span class='line'>def get_cur_info():
</span><span class='line'>    print sys._getframe().f_code.co_name
</span><span class='line'>    print sys._getframe().f_back.f_code.co_name
</span><span class='line'>get_cur_info()</span></code></pre></td></tr></table></div></figure>


<p>调用结果是:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>get_cur_info
</span><span class='line'>&lt;module&gt;</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.vimer.cn/2010/12/%E5%9C%A8python%E4%B8%AD%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E4%BD%8D%E7%BD%AE%E6%89%80%E5%9C%A8%E7%9A%84%E8%A1%8C%E5%8F%B7%E5%92%8C%E5%87%BD%E6%95%B0%E5%90%8D.html">转载地址</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/18/linux-self-extract/">Linux自解压文件</a></h1>
    
    
      <p class="meta">
        




<time class='entry-date' datetime='2015-06-18T08:44:00+00:00'><span class='date'><span class='date-month'>Jun</span> <span class='date-day'>18</span><span class='date-suffix'>th</span>, <span class='date-year'>2015</span></span> <span class='time'>8:44 am</span></time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>经常从网络上下载.run格式的安装包，直接运行就能够执行程序安装了，很简单方便，一直也没有仔细研究过，前段时间学习开源交换机ONIE的NOS安装镜像，需要自己制作一个NOS的安装镜像，于是就学习了一下。</p>

<h3>网上最常用的一种方式是通过tail命令+tar命令来实现：</h3>

<ul>
<li>首先把想要安装的文件通过tar命令进行打包，当然也可用zip、gunzip等命令</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ls
</span><span class='line'>target
</span><span class='line'>
</span><span class='line'>$tar -cvf target.tar target/
</span><span class='line'>target/
</span><span class='line'>target/t.sh
</span><span class='line'>target/System.map
</span><span class='line'>
</span><span class='line'>$ls
</span><span class='line'>target.tar</span></code></pre></td></tr></table></div></figure>


<ul>
<li>新建自解压脚本，本例取名self_extract.sh,可以自己修改这个脚本，添加自己的安装过程。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat self_extract.sh                                                                      
</span><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>lines=%%SELF_EXTRACT_LINES%%
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>tail $lines $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>#添加你自己的安装过程
</span><span class='line'>
</span><span class='line'>exit 0</span></code></pre></td></tr></table></div></figure>


<ul>
<li>修改这个self_extract.sh文件中的<code>%%SELF_EXTRACT_LINES%%</code>变量。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$LINE=$(wc -l self_extract.sh | awk -F" " '{print $1+1}')| echo $LINE | sed -i -e "s/%%SELF_EXTRACT_LINES%%/$LINE/" self_extract.sh</span></code></pre></td></tr></table></div></figure>


<p>修改后的脚本文件为：</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>lines=10
</span><span class='line'>
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>tail -n +$lines $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>exit 0
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>把第一步生成的target.tar文件追加到slef_extract.sh脚本。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat target.tar &gt;&gt; self_extract.sh</span></code></pre></td></tr></table></div></figure>


<ul>
<li>执行最终生成的self_extract.sh后，目录下就会最终生成target目录了。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./self_extract.sh 
</span><span class='line'>$ls
</span><span class='line'>self_extract.sh  target</span></code></pre></td></tr></table></div></figure>


<h3>ONIE的做法</h3>

<ul>
<li>ONIE的做法更加简洁：</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat self_extract.sh 
</span><span class='line'>#/bin/sh
</span><span class='line'>
</span><span class='line'>target_file=$(readlink -f $0)
</span><span class='line'>
</span><span class='line'>sed -e '1,/^__exit_marker__$/d' $target_file | tar xf -
</span><span class='line'>
</span><span class='line'>exit 0
</span><span class='line'>
</span><span class='line'>__exit_marker__</span></code></pre></td></tr></table></div></figure>


<ul>
<li>追加target.tar到self_extrac.sh文件。</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$cat target.tar &gt;&gt; self_extract.sh</span></code></pre></td></tr></table></div></figure>


<ul>
<li>执行self_extract.sh就可以了</li>
</ul>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$./self_extract.sh 
</span><span class='line'>$ls
</span><span class='line'>self_extract.sh  target</span></code></pre></td></tr></table></div></figure>


<h3>ONIE格式的安装包加入校验</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>sha1=$(sed -e '1,/^__exit_marker__$/d' "$0" | sha1sum | awk '{ print $1 }')
</span><span class='line'>
</span><span class='line'>payload_sha1=%%IMAGE_SHA1%%
</span><span class='line'>
</span><span class='line'>if [ "$sha1" != "$payload_sha1" ] ; then
</span><span class='line'>    echo
</span><span class='line'>    echo "ERROR: Unable to verify archive checksum"
</span><span class='line'>    echo "Expected: $payload_sha1"
</span><span class='line'>    echo "Found   : $sha1"
</span><span class='line'>    exit 1
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>


<p>需要在把target.tar文件追加到self_extract.sh之前，先替换<code>%%IMAGS_SHA1%%</code>变量。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$SHASUM=$(sha1sum target.tar | awk '{print $1}') | sed -i -e 's/%%IMAGE_SHA1%%/$SHASUM' self_extrac.sh</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/posts/4">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/posts/2">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2019/05/30/minikube-install/">Minikube Install</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/28/xubuntu-upgrade/">Xubuntu Upgrade</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/05/27/reset-env-for-running-process/">Reset-env-for-running-process</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/27/iptables-with-time/">Iptables时间规则匹配</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/04/27/redirect-extern-request-to-localhost/">重定向外部连接到本地环回地址</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Categories</h1>
    <ul id="category-list"><li><a href='/blog/categories/iptables/'>iptables (1)</a></li><li><a href='/blog/categories/kernel/'>kernel (5)</a></li><li><a href='/blog/categories/linuxc/'>linuxc (1)</a></li><li><a href='/blog/categories/linuxbian-cheng/'>linux编程 (1)</a></li><li><a href='/blog/categories/makefile/'>makefile (2)</a></li><li><a href='/blog/categories/netfilter/'>netfilter (1)</a></li><li><a href='/blog/categories/ocp/'>ocp (2)</a></li><li><a href='/blog/categories/python/'>python (1)</a></li><li><a href='/blog/categories/regax/'>regax (1)</a></li><li><a href='/blog/categories/shell/'>shell (3)</a></li><li><a href='/blog/categories/sourceinsight/'>sourceinsight (1)</a></li><li><a href='/blog/categories/sysctl/'>sysctl (1)</a></li><li><a href='/blog/categories/todo/'>todo (1)</a></li><li><a href='/blog/categories/ubuntu/'>ubuntu (1)</a></li><li><a href='/blog/categories/vim/'>vim (1)</a></li><li><a href='/blog/categories/chuan-kou/'>串口 (1)</a></li><li><a href='/blog/categories/gong-ju/'>工具 (2)</a></li><li><a href='/blog/categories/wang-luo/'>网络 (3)</a></li><li><a href='/blog/categories/she-ji-mo-shi/'>设计模式 (1)</a></li></ul>
</section>
<section>
  <h1>Tag Cloud</h1>
    <span id="tag-cloud"><a href='/blog/categories/iptables' style='font-size: 112.0%'>iptables(1)</a> <a href='/blog/categories/kernel' style='font-size: 160.0%'>kernel(5)</a> <a href='/blog/categories/linuxc' style='font-size: 112.0%'>linuxc(1)</a> <a href='/blog/categories/linuxbian-cheng' style='font-size: 112.0%'>linux编程(1)</a> <a href='/blog/categories/makefile' style='font-size: 124.0%'>makefile(2)</a> <a href='/blog/categories/netfilter' style='font-size: 112.0%'>netfilter(1)</a> <a href='/blog/categories/ocp' style='font-size: 124.0%'>ocp(2)</a> <a href='/blog/categories/python' style='font-size: 112.0%'>python(1)</a> <a href='/blog/categories/regax' style='font-size: 112.0%'>regax(1)</a> <a href='/blog/categories/shell' style='font-size: 136.0%'>shell(3)</a> <a href='/blog/categories/sourceinsight' style='font-size: 112.0%'>sourceinsight(1)</a> <a href='/blog/categories/sysctl' style='font-size: 112.0%'>sysctl(1)</a> <a href='/blog/categories/todo' style='font-size: 112.0%'>todo(1)</a> <a href='/blog/categories/ubuntu' style='font-size: 112.0%'>ubuntu(1)</a> <a href='/blog/categories/vim' style='font-size: 112.0%'>vim(1)</a> <a href='/blog/categories/chuan-kou' style='font-size: 112.0%'>串口(1)</a> <a href='/blog/categories/gong-ju' style='font-size: 124.0%'>工具(2)</a> <a href='/blog/categories/wang-luo' style='font-size: 136.0%'>网络(3)</a> <a href='/blog/categories/she-ji-mo-shi' style='font-size: 112.0%'>设计模式(1)</a> </span>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2019 - Iskey -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  











</body>
</html>
